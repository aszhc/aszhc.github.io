<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Docker 底层实现原理及关键技术 | PHOENIX</title>
    <meta property="og:title" content="Docker 底层实现原理及关键技术 - PHOENIX">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-07-13T10:59:52&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-07-13T10:59:52&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,博客,项目管理,python,公众号">
    <meta name="description" content="Docker 底层实现原理及关键技术">
        
    <meta name="author" content="周闖">
    <meta property="og:url" content="https://aszhc.github.io/post/Docker/Docker-02/">
    
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-4031353640611810",
        enable_page_level_ads: true
    });
    </script>
    


    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://aszhc.github.io">
                        PHOENIX
                    </a>
                
                <p class="description">Computers do not solve problems, they execute solutions.</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://aszhc.github.io">首页</a>
                    
                    <a  href="https://aszhc.github.io/collect/" title="搜集">搜集</a>
                    
                    <a  href="https://aszhc.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://aszhc.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 250px;
        margin-left: -300px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ol>
    <li><a href="#资源隔离为什么构建容器需要namespace">资源隔离：为什么构建容器需要Namespace</a>
      <ol>
        <li><a href="#什么是namespace">什么是Namespace</a></li>
        <li><a href="#为什么docker需要namespace">为什么Docker需要Namespace？</a></li>
        <li><a href="#小结">小结：</a></li>
      </ol>
    </li>
    <li><a href="#资源限制如何通过cgroups机制实现资源限制">资源限制：如何通过Cgroups机制实现资源限制？</a>
      <ol>
        <li><a href="#cgroups">cgroups</a></li>
        <li><a href="#cgroups子系统实例">cgroups子系统实例</a></li>
        <li><a href="#docker是如何使用cgroups的">Docker是如何使用cgroups的</a></li>
        <li><a href="#小结-1">小结</a></li>
      </ol>
    </li>
    <li><a href="#组件组成剖析docker组件作用及其底层工作原理">组件组成：剖析Docker组件作用及其底层工作原理</a>
      <ol>
        <li><a href="#docker-的组件构成">Docker 的组件构成</a></li>
        <li><a href="#docker-组件剖析">Docker 组件剖析</a></li>
        <li><a href="#docker相关组件">Docker相关组件</a></li>
        <li><a href="#containerd-相关组件">containerd 相关组件</a></li>
        <li><a href="#容器运行时组件runc">容器运行时组件runc</a></li>
        <li><a href="#总结">总结</a></li>
      </ol>
    </li>
    <li><a href="#网络模型剖析docker网络实现及libnetwork底层原理">网络模型：剖析Docker网络实现及Libnetwork底层原理</a>
      <ol>
        <li><a href="#容器网络发展史">容器网络发展史</a></li>
        <li><a href="#cnm">CNM</a></li>
        <li><a href="#libnetwork-的工作流程">Libnetwork 的工作流程</a></li>
        <li><a href="#libnetwork-常见网络模式">Libnetwork 常见网络模式</a></li>
        <li><a href="#小结-2">小结</a></li>
      </ol>
    </li>
    <li><a href="#数据存储剖析docker卷与持久化数据存储的底层原理">数据存储：剖析Docker卷与持久化数据存储的底层原理</a>
      <ol>
        <li><a href="#为什么容器需要持久化存储">为什么容器需要持久化存储</a></li>
        <li><a href="#docker-卷的操作">Docker 卷的操作</a></li>
        <li><a href="#docker-卷的实现原理">Docker 卷的实现原理</a></li>
        <li><a href="#结语">结语</a></li>
      </ol>
    </li>
    <li><a href="#文件存储驱动aufs">文件存储驱动：AUFS</a>
      <ol>
        <li><a href="#什么是联合文件系统">什么是联合文件系统</a></li>
        <li><a href="#如何配置-docker-的-aufs-模式">如何配置 Docker 的 AUFS 模式</a></li>
        <li><a href="#aufs-工作原理">AUFS 工作原理</a></li>
      </ol>
    </li>
    <li><a href="#文件存储驱动devicemapper">文件存储驱动：Devicemapper</a>
      <ol>
        <li><a href="#什么是-devicemapper-">什么是 Devicemapper ？</a></li>
        <li><a href="#devicemapper-的关键技术">Devicemapper 的关键技术</a></li>
        <li><a href="#devicemapper-是如何数据存储的">Devicemapper 是如何数据存储的？</a></li>
        <li><a href="#devicemapper-如何实现镜像分层与共享">Devicemapper 如何实现镜像分层与共享？</a></li>
      </ol>
    </li>
    <li><a href="#文件存储驱动overlayfs">文件存储驱动：OverlayFS</a>
      <ol>
        <li><a href="#overlay2-工作原理">overlay2 工作原理</a></li>
        <li><a href="#结语-1">结语</a></li>
      </ol>
    </li>
  </ol>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">Docker 底层实现原理及关键技术</h1>
        </header>
        <date class="post-meta meta-date">
            2021年7月13日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='https://aszhc.github.io/categories/Docker'>Docker</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <h2 id="资源隔离为什么构建容器需要namespace">资源隔离：为什么构建容器需要Namespace</h2>
<h3 id="什么是namespace">什么是Namespace</h3>
<p>维基百科定义：</p>
<p>Namespace是Linux内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。Namespace的工作方式通过为一组资源和进程设置相同的Namespace而起作用，但是这些Namespace引用了不同的资源。资源可能存在于多个Namespace中。这些资源可以是进程ID、主机名、用户ID、文件名、与网络访问相关的名称和进程间通信。</p>
<table>
<thead>
<tr>
<th>Namespace名称</th>
<th>作用</th>
<th>内核版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mount（mnt）</td>
<td>隔离挂载点</td>
<td>2.4.19</td>
</tr>
<tr>
<td>Process ID （pid）</td>
<td>隔离进程ID</td>
<td>2.6.24</td>
</tr>
<tr>
<td>Network（net）</td>
<td>隔离网络接口、端口号等</td>
<td>2.6.29</td>
</tr>
<tr>
<td>Interprocess Communication（ipc）</td>
<td>隔离System V IPC和POSIX message queues</td>
<td>2.6.19</td>
</tr>
<tr>
<td>UTS Namespace（uts）</td>
<td>隔离主机名和域名</td>
<td>2.6.19</td>
</tr>
<tr>
<td>User Namespace（user）</td>
<td>隔离用户和用户组</td>
<td>3.8</td>
</tr>
<tr>
<td>Control group（cgroup）Namespace</td>
<td>隔离Cgroups根目录</td>
<td>4.6</td>
</tr>
<tr>
<td>Time Namespace</td>
<td>隔离系统时间</td>
<td>5.6</td>
</tr>
</tbody>
</table>
<h4 id="各种namespace的作用">各种Namespace的作用</h4>
<ol>
<li>
<p>Mount Namespace</p>
<blockquote>
<p>隔离不同的进程或进程组看到的挂载点</p>
</blockquote>
<p>实现容器内只能看到自己的挂载信息，在容器内的挂载操作不会影响主机的挂载目录</p>
<p>实例：</p>
<p><code>unshare</code>是util-linux工具包中的一个工具，可以实现创建并访问不同类型的Namespace</p>
<p>创建一个bash进程并且新建一个Mount Namespace</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo unshare --mount --fork /bin/bash
root@zhou:/home/zhou# 
</code></pre></td></tr></table>
</div>
</div><p>在/tmp 目录下创建一个目录</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# mkdir /tmp/tmpfs
</code></pre></td></tr></table>
</div>
</div><p>使用mount命令挂载一个tmpfs类型的目录</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# mount -t tmpfs -o <span style="color:#b8860b">size</span><span style="color:#666">=</span>20m tmpfs /tmp/tmpfs
</code></pre></td></tr></table>
</div>
</div><p>使用df命令查看已经挂载的目录信息</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# df -h
文件系统        容量  已用  可用 已用% 挂载点
/dev/sda3       117G   93G   18G   85% /
udev            7.7G     <span style="color:#666">0</span>  7.7G    0% /dev
 ......
tmpfs            20M     <span style="color:#666">0</span>   20M    0% /tmp/tmpfs
</code></pre></td></tr></table>
</div>
</div><p>新打开一个命令行窗口，执行df命令查看主机的挂载信息，可以看到主机上并没有该挂载目录</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ df -h
文件系统        容量  已用  可用 已用% 挂载点
udev            7.7G     <span style="color:#666">0</span>  7.7G    0% /dev
tmpfs           1.6G  4.1M  1.6G    1% /run
/dev/sda3       117G   93G   18G   85% /
tmpfs           7.8G   71M  7.7G    1% /dev/shm
tmpfs           5.0M  4.0K  5.0M    1% /run/lock
......
</code></pre></td></tr></table>
</div>
</div><p>可见mount Namespace中的mount操作并不会影响主机</p>
<p><strong>继续验证：</strong></p>
<p>在当前命令行窗口查看当前进程的Namespace信息</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# ls -l /proc/self/ns
总用量 <span style="color:#666">0</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 cgroup -&gt; <span style="color:#b44">&#39;cgroup:[4026531835]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 ipc -&gt; <span style="color:#b44">&#39;ipc:[4026531839]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 mnt -&gt; <span style="color:#b44">&#39;mnt:[4026532666]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 net -&gt; <span style="color:#b44">&#39;net:[4026532008]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 pid -&gt; <span style="color:#b44">&#39;pid:[4026531836]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 pid_for_children -&gt; <span style="color:#b44">&#39;pid:[4026531836]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 <span style="color:#a2f">time</span> -&gt; <span style="color:#b44">&#39;time:[4026531834]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 time_for_children -&gt; <span style="color:#b44">&#39;time:[4026531834]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 user -&gt; <span style="color:#b44">&#39;user:[4026531837]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:45 uts -&gt; <span style="color:#b44">&#39;uts:[4026531838]&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>新打开一个命令行窗口，使用相同的命令查看主机上的Namespace信息</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ ls -l /proc/self/ns 
总用量 <span style="color:#666">0</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 cgroup -&gt; <span style="color:#b44">&#39;cgroup:[4026531835]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 ipc -&gt; <span style="color:#b44">&#39;ipc:[4026531839]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 mnt -&gt; <span style="color:#b44">&#39;mnt:[4026531840]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 net -&gt; <span style="color:#b44">&#39;net:[4026532008]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 pid -&gt; <span style="color:#b44">&#39;pid:[4026531836]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 pid_for_children -&gt; <span style="color:#b44">&#39;pid:[4026531836]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 <span style="color:#a2f">time</span> -&gt; <span style="color:#b44">&#39;time:[4026531834]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 time_for_children -&gt; <span style="color:#b44">&#39;time:[4026531834]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 user -&gt; <span style="color:#b44">&#39;user:[4026531837]&#39;</span>
lrwxrwxrwx <span style="color:#666">1</span> zhou zhou <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 09:48 uts -&gt; <span style="color:#b44">&#39;uts:[4026531838]&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到除了mnt id不一致外，其他Namespace的id均一致</p>
<p>所以我们可以得出结论：<strong>使用unshare命令可以新建Mount Namespace，并且在新建的Mount Namespace内是和外部完全隔离的</strong></p>
</li>
<li>
<p>PID Namespace</p>
<blockquote>
<p>PID Namespace 的作用是用来隔离进程的</p>
</blockquote>
<p>例如一个进程在主机上的PID为122，使用PID Namespace可以实现该进程在容器内看到的PID为1</p>
<p>实例：</p>
<p>创建一个bash进程，并且新建一个PID Namespace</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ sudo unshare --pid --fork --mount-proc /bin/bash
root@zhou:/home/zhou# 
</code></pre></td></tr></table>
</div>
</div><p>在当前的命令行窗口使用ps aux命令查看进程信息</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           <span style="color:#666">1</span>  0.0  0.0  <span style="color:#666">12920</span>  <span style="color:#666">3884</span> pts/0    S    09:55   0:00 /bin/bash
root           <span style="color:#666">8</span>  0.0  0.0  <span style="color:#666">14592</span>  <span style="color:#666">3248</span> pts/0    R+   09:55   0:00 ps aux
</code></pre></td></tr></table>
</div>
</div><p>这里我们可以看到bash进程，但是看不到主机上的进程</p>
</li>
<li>
<p>UTS Namespace</p>
<blockquote>
<p>UTS Namespace主要是用来隔离主机名的，它允许每个UTS Namespace拥有一个独立主机名</p>
</blockquote>
<p>实例：</p>
<p>使用unshare命令创建一个UTS Namespace</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ sudo unshare --uts --fork /bin/bash           
root@zhou:/home/zhou# 
</code></pre></td></tr></table>
</div>
</div><p>使用hostname命令（hostname用来查看主机名称）设置主机</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# hostname -b xxx
</code></pre></td></tr></table>
</div>
</div><p>查看主机名</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# hostname
xxx
</code></pre></td></tr></table>
</div>
</div><p>新建一个hostname，使用相同的命令查看主机的hostname</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ hostname
zhou
</code></pre></td></tr></table>
</div>
</div><p>所以可以验证uts namespace隔离主机名</p>
</li>
<li>
<p>IPC Namespace</p>
<blockquote>
<p>IPC Namespace 主要是用来隔离进程间通信的</p>
</blockquote>
<p>PID Namespace和IPC Namespace 一起使用可以实现同一IPC Namespace 内的进程彼此可以通信，不同IPC Namespace 的进程却不能通信</p>
<p>实例：</p>
<p>使用unshare命令创建一个IPC Namespace</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ sudo unshare --ipc --fork /bin/bash
root@zhou:/home/zhou# 
</code></pre></td></tr></table>
</div>
</div><ul>
<li>ipcs -q 命令：查看系统间通信队列列表</li>
<li>ipcmk -Q 命令： 创建系统间通信队列</li>
</ul>
<p>使用ipcs -q 命令查看当前IPC Namespace下的系统通信队列列表</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# ipcs -q
   
--------- 消息队列 -----------
键        msqid      拥有者  权限     已用字节数 消息 
</code></pre></td></tr></table>
</div>
</div><p>使用ipcmk -Q 命令创建一个系统通信队列</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# ipcmk -Q
消息队列 id：0
</code></pre></td></tr></table>
</div>
</div><p>再次使用 ipcs -q 命令查看当前 IPC Namespace 下的通信队列列表</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# ipcs -q
   
--------- 消息队列 -----------
键        msqid      拥有者  权限     已用字节数 消息      
0xb44cbe69 <span style="color:#666">0</span>          root       <span style="color:#666">644</span>        <span style="color:#666">0</span>            <span style="color:#666">0</span> 
</code></pre></td></tr></table>
</div>
</div><p>打开一个新的命令行窗口， 使用 ipcs -q 命令查看主机的系统通信队列</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ ipcs -q 
   
--------- 消息队列 -----------
键        msqid      拥有者  权限     已用字节数 消息 
</code></pre></td></tr></table>
</div>
</div><p>我们可以看到IPC Namespace与主机是隔离的</p>
</li>
<li>
<p>User Namespace</p>
<blockquote>
<p>User Namespace 主要是用来隔离用户和用户组的</p>
</blockquote>
<p>使用 User Namespace 可以实现进程在容器内拥有 root 权限，而在主机上却只是普通用户</p>
<p>实例：以普通用户的身份创建一个User Namespace</p>
<pre><code>➜  ~ unshare --user -r /bin/bash        
root@zhou:~# 
</code></pre><p>执行 id 命令查看当前的用户信息</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:~# id
<span style="color:#b8860b">用户id</span><span style="color:#666">=</span>0<span style="color:#666">(</span>root<span style="color:#666">)</span> <span style="color:#b8860b">组id</span><span style="color:#666">=</span>0<span style="color:#666">(</span>root<span style="color:#666">)</span> <span style="color:#b8860b">组</span><span style="color:#666">=</span>0<span style="color:#666">(</span>root<span style="color:#666">)</span>,65534<span style="color:#666">(</span>nogroup<span style="color:#666">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>reboot命令只有root用户可以使用</code>, 在当前命令行窗口执行reboot 命令</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:~# reboot
Failed to connect to bus: 不允许的操作
Failed to open initctl fifo: 权限不够
Failed to talk to init daemon.
</code></pre></td></tr></table>
</div>
</div><p>我们可以看到，在User Namespace中虽然是root用户，但是并没有权限执行reboot命令，所以User Namespace实现了用户与用户组的隔离</p>
</li>
<li>
<p>Net Namespace</p>
<blockquote>
<p>Net Namespace 用来隔离网络设备、IP 地址和端口等信息</p>
</blockquote>
<p>Net Namespace 可以让每个进程拥有自己独立的 IP 地址，端口和网卡信息</p>
<p>例如主机 IP 地址为 172.16.4.1，容器内可以是指独立的 IP 地址为192.168.1.1</p>
<p>实例：</p>
<p>使用 ip a 查看网络信息</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ ip a   
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#666">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#666">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp2s0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span style="color:#666">1500</span> qdisc fq_codel state DOWN group default qlen <span style="color:#666">1000</span>
    link/ether f4:8e:38:f5:82:01 brd ff:ff:ff:ff:ff:ff
3: wlp3s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#666">1500</span> qdisc noqueue state UP group default qlen <span style="color:#666">1000</span>
    link/ether f8:34:41:be:1f:9f brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.42/24 brd 192.168.1.255 scope global dynamic noprefixroute wlp3s0
       valid_lft 79541sec preferred_lft 79541sec
    inet6 fe80::8d88:83cf:fa45:be94/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
   
</code></pre></td></tr></table>
</div>
</div><p>创建一个Net Namespace</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ sudo unshare --net --fork /bin/bash
root@zhou:/home/zhou# 
</code></pre></td></tr></table>
</div>
</div><p>查看网络信息</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zhou:/home/zhou# ip a
1: lo: &lt;LOOPBACK&gt; mtu <span style="color:#666">65536</span> qdisc noop state DOWN group default qlen <span style="color:#666">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</code></pre></td></tr></table>
</div>
</div><p>可以看到，Namespace内的网络信息与主机不同</p>
</li>
</ol>
<h3 id="为什么docker需要namespace">为什么Docker需要Namespace？</h3>
<p>Linux内核从 2002 年 2.4.19 版本开始加入了 Mount Namespace</p>
<p>内核 3.8 版本加入了 User Namespace 为容器提供了足够的支持功能</p>
<p>当一个Docker 新建一个容器时</p>
<p>会创建这六种 Namespace，然后将容器中的进程加入这些 Namespace之中</p>
<h3 id="小结">小结：</h3>
<blockquote>
<p>Namespace 是Linux内核的一个特性</p>
</blockquote>
<p>可以实现在同一主机系统中对进程 ID、主机名、用户 ID、文件名、网络和进程间通信等资源的隔离</p>
<h2 id="资源限制如何通过cgroups机制实现资源限制">资源限制：如何通过Cgroups机制实现资源限制？</h2>
<p>我们可以知道使用不同的Namespace，可以实现容器中的进程看不到别的容器的资源，但是容器内的进程仍然可以任意地使用主机的CPU、内存等资源，如果某一个容器使用的主机资源过多，可能导致主机的资源竞争，进而影响业务。</p>
<p>这里就需要使用到Linux内核的另一个核心技术 <strong>cgroups</strong>。</p>
<h3 id="cgroups">cgroups</h3>
<p>cgroups（全称：control groups）是 Linux 内核的一个功能，它可以实现限制进程或者进程组的资源（如 CPU、内存、磁盘 IO 等）。</p>
<blockquote>
<p>在 2006 年，Google 的工程师（ Rohit Seth 和 Paul Menage 为主要发起人） 发起了这个项目，
起初项目名称并不是 cgroups，而被称为进程容器（process containers）。在 2007 年 cgroups
代码计划合入 Linux 内核，但是当时在 Linux 内核中，容器（container）这个词被广泛使用，并
且拥有不同的含义。为了避免命名混乱和歧义，进程容器被重名为 cgroups，并在 2008 年成功
合入 Linux 2.6.24 版本中。cgroups 目前已经成为 systemd、Docker、Linux
Containers（LXC） 等技术的基础。</p>
</blockquote>
<h4 id="cgroups-功能及核心概念">cgroups 功能及核心概念</h4>
<p>cgroups 主要提供了如下功能：</p>
<ul>
<li>资源限制：限制资源的使用量，例如可以通过限制某个业务的内存上限，从而保护主机其他业务的安全运行。</li>
<li>优先级控制：不同的组可以有不同的资源（CPU、磁盘 IO 等）使用优先级</li>
<li>审计：计算控制组的资源使用情况</li>
<li>控制：控制进程的挂起或恢复</li>
</ul>
<p>了解了 cgroup 可以为我们提供什么功能，下面来看一下cgroup 是如何实现这些功能的。</p>
<p>cgroup功能的实现依赖与三个核心概念：子系统、控制组、层级树。</p>
<ul>
<li><strong>子系统</strong>（subsystem）：是一个内核组件，一个子系统代表一类资源调度控制器。例如内存子系统可以限制内存的使用量，CPU 子系统可以限制 CPU 的使用时间。</li>
<li><strong>控制组</strong>（cgroup）：标志一组进程和一组带有参数的子系统的关联关系。例如，一个进程使用了CPU子系统来限制CPU的使用时间，则这个进程和CPU子系统的关联关系称为控制组。</li>
<li><strong>层级树</strong>（hierarchy）：是由一系列的控制组按照树状结构排列组成的。这种排列方式可以使得控制组拥有父子关系，子控制组默认拥有父控制组的属性，也就是子控制组会继承于父控制组。比如，系统中定义了一个控制组 c1，限制了 CPU 可以使用 1 核，然后另外一个控制组 c2 想实现既限制 CPU 使用 1 核，同时限制内存使用 2G，那么 c2 就可以直接继承 c1，无须重复定义 CPU 限制。</li>
</ul>
<p>cgroups 的这三个核心概念中，子系统是最核心的概念，因为子系统是真正实现某类资源限制的基础。</p>
<h3 id="cgroups子系统实例">cgroups子系统实例</h3>
<p>下面我通过一个实例演示一下在 Linux 上默认都启动了哪些子系统。</p>
<p>我们先通过 mount 命令查看一下当前系统已经挂载的 cgroups 信息：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ sudo mount -t cgroup                                      
cgroup on /sys/fs/cgroup/systemd <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,xattr,name<span style="color:#666">=</span>systemd<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/rdma <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,rdma<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/net_cls,net_prio <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,net_cls,net_prio<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/perf_event <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,perf_event<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/freezer <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,freezer<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/cpuset <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,cpuset<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/devices <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,devices<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/pids <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,pids<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/blkio <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,blkio<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/memory <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,memory<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/cpu,cpuacct <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,cpu,cpuacct<span style="color:#666">)</span>
cgroup on /sys/fs/cgroup/hugetlb <span style="color:#a2f">type</span> cgroup <span style="color:#666">(</span>rw,nosuid,nodev,noexec,relatime,hugetlb<span style="color:#666">)</span>
</code></pre></td></tr></table>
</div>
</div><p>通过输出，可以看到当前系统已经挂载了我们常用cgroups子系统，例如 cpu、memory、pids 等我们常用的cgroups 子系统。这些子系统中，cpu和memory子系统是容器环境中使用最多的子系统，下面我对这两个子系统做详细介绍。</p>
<h4 id="cpu-子系统">cpu 子系统</h4>
<p>我首先以 cpu 子系统为例，演示一下 cgroups 如何限制进程的 cpu 使用时间。由于 cgroups 的操作很多需要用到 root 权限，我们在执行命令前要确保已经切换到了 root 用户，以下命令的执行默认都是使用 root 用户。</p>
<ol>
<li>
<p>在cpu子系统下创建 cgroup</p>
<p>cgroups 的创建很简单，只需要在相应的子系统下创建目录即可。下面我们到cpu子系统下创建测试文件夹</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# mkdir /sys/fs/cgroup/cpu/mydocker
</code></pre></td></tr></table>
</div>
</div><p>执行完命令之后，我们查看以下新创建的目录下发生了什么</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# ls -l /sys/fs/cgroup/cpu/mydocker 
总用量 <span style="color:#666">0</span>
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cgroup.clone_children
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cgroup.procs
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpuacct.stat
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpuacct.usage
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpuacct.usage_all
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpuacct.usage_percpu
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpuacct.usage_percpu_sys
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpuacct.usage_percpu_user
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpuacct.usage_sys
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpuacct.usage_user
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpu.cfs_period_us
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpu.cfs_quota_us
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpu.shares
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpu.stat
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpu.uclamp.max
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 cpu.uclamp.min
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 notify_on_release
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:03 tasks
</code></pre></td></tr></table>
</div>
</div><p>由上可以看到我们新建的目录下被自动创建了很多文件，其中cpu.cfs_quota_us 文件代表在某一个阶段限制的CPU时间总量，单位为微妙。例如，我们想限制某个进程最多使用1核CPU，就在这个文件里写入100000（100000代表限制1核），tasks 文件中写入进程ID即可（如果要限制多个进程ID，在tasks文件中换行符分隔即可）。</p>
<p>此时，我们所需要的cgroup就创建好了。</p>
</li>
<li>
<p>创建进程，加入cgroup</p>
<p>这里为了方便演示，我先把当前运行的shell进程加入cgroup，然后在当前shell运行cpu耗时任务（这里利用到继承，子进程会继承父进程的cgroup）。</p>
<p>使用以下命令将shell进程加入cgroup中：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# <span style="color:#a2f">cd</span> /sys/fs/cgroup/cpu/mydocker
zhou# <span style="color:#a2f">echo</span> <span style="color:#b8860b">$$</span> &gt; tasks 
</code></pre></td></tr></table>
</div>
</div><p>查看一下 tasks 文件内容：</p>
<p>其中第一个进程ID为当前shell的主进程，也就是说，当前shell的主进程为22173</p>
</li>
<li>
<p>执行 cpu 耗时任务，验证cgroup是否可以限制cpu使用时间</p>
<p>下面，我们使用以下命令制造一个死循环，来提升cpu使用率：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# <span style="color:#a2f;font-weight:bold">while</span> true;<span style="color:#a2f;font-weight:bold">do</span> echo;<span style="color:#a2f;font-weight:bold">done</span>;
</code></pre></td></tr></table>
</div>
</div><p>执行完上述命令后，我们新打开一个shell窗口，使用top -p命令查看当前cpu使用率，-p参数后面跟进程ID，我这里是22173</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ top -p <span style="color:#666">22173</span>
   
任务:   <span style="color:#666">1</span> total,   <span style="color:#666">1</span> running,   <span style="color:#666">0</span> sleeping,   <span style="color:#666">0</span> stopped,   <span style="color:#666">0</span> zombie
%Cpu<span style="color:#666">(</span>s<span style="color:#666">)</span>: 28.7 us, 27.1 sy,  0.0 ni, 43.7 id,  0.5 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :  15777.9 total,   5220.3 free,   5201.6 used,   5356.1 buff/cache
MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.  10163.8 avail Mem 
   
 进程号 USER      PR  NI    VIRT    RES    SHR    %CPU  %MEM     TIME+ COMMAND                                                                                                                                
  <span style="color:#666">22173</span> root      <span style="color:#666">20</span>   <span style="color:#666">0</span>   <span style="color:#666">18880</span>   <span style="color:#666">6828</span>   <span style="color:#666">4964</span> R 100.0   0.0   1:10.42 zsh  
</code></pre></td></tr></table>
</div>
</div><p>通过上面输出可以看到22173这个进程被限制到了只能使用100%的CPU，也就是1个核。说明我们使用cgroup来限制cpu使用时间已经生效。此时，执行while循环的命令窗口可以使用关闭了。</p>
<p>为了进一步证实cgroup限制cpu的准确性，我们修改cpu限制时间为0.5核心，命令如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# <span style="color:#a2f">cd</span> /sys/fs/cgroup/cpu/mydocker 
zhou# <span style="color:#a2f">echo</span> <span style="color:#666">50000</span> &gt; cpu.cfs_quota_us 
</code></pre></td></tr></table>
</div>
</div><p>同样使用上面命令来制造死循环：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# <span style="color:#a2f;font-weight:bold">while</span> true;<span style="color:#a2f;font-weight:bold">do</span> echo;<span style="color:#a2f;font-weight:bold">done</span>;  
</code></pre></td></tr></table>
</div>
</div><p>保持当前窗口，新打开一个shell窗口，使用top -p参数查看cpu使用率：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ top -p <span style="color:#666">22173</span>
   
top - 13:45:44 up  4:58,  <span style="color:#666">1</span> user,  load average: 2.17, 1.05, 0.63
任务:   <span style="color:#666">1</span> total,   <span style="color:#666">1</span> running,   <span style="color:#666">0</span> sleeping,   <span style="color:#666">0</span> stopped,   <span style="color:#666">0</span> zombie
%Cpu<span style="color:#666">(</span>s<span style="color:#666">)</span>: 19.4 us, 15.2 sy,  0.0 ni, 65.4 id,  0.1 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :  15777.9 total,   5229.3 free,   5169.1 used,   5379.5 buff/cache
MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.  10192.3 avail Mem 
   
 进程号 USER      PR  NI    VIRT    RES    SHR    %CPU  %MEM     TIME+ COMMAND  
  <span style="color:#666">22173</span> root      <span style="color:#666">20</span>   <span style="color:#666">0</span>   <span style="color:#666">18880</span>   <span style="color:#666">6948</span>   <span style="color:#666">5084</span> R  50.0   0.0   1:46.72 zsh  
</code></pre></td></tr></table>
</div>
</div><p>通过上面输出可以看到，此时cpu使用率已经被限制到了50%，即为0.5个核心。</p>
<p>验证完cgroup限制cpu，我们使用相似的方法来验证cgroup对内存的限制。</p>
</li>
</ol>
<h4 id="memroy-子系统">memroy 子系统</h4>
<ol>
<li>
<p>在memory子系统下创建cgroup</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# mkdir /sys/fs/cgroup/memory/mydocker
</code></pre></td></tr></table>
</div>
</div><p>同样，我们查看以下新创建的目录下发生了什么？</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# ls -l /sys/fs/cgroup/memory/mydocker 
总用量 <span style="color:#666">0</span>
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 cgroup.clone_children
--w--w--w- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 cgroup.event_control
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 cgroup.procs
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.failcnt
--w------- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.force_empty
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.kmem.failcnt
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.kmem.limit_in_bytes
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.kmem.max_usage_in_bytes
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.kmem.slabinfo
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.kmem.tcp.failcnt
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.kmem.tcp.limit_in_bytes
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.kmem.tcp.max_usage_in_bytes
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.kmem.tcp.usage_in_bytes
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.kmem.usage_in_bytes
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.limit_in_bytes
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.max_usage_in_bytes
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.memsw.failcnt
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.memsw.limit_in_bytes
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.memsw.max_usage_in_bytes
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.memsw.usage_in_bytes
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.move_charge_at_immigrate
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.numa_stat
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.oom_control
---------- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.pressure_level
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.soft_limit_in_bytes
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.stat
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.swappiness
-r--r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.usage_in_bytes
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 memory.use_hierarchy
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 notify_on_release
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 13:49 tasks
</code></pre></td></tr></table>
</div>
</div><p>其中memory.limit_in_bytes文件代表内存使用总量，单位为byte。</p>
<p>例如，这里我希望对内存使用限制为1G，则向memory.limit_in_bytes文件写入1073741824，命令如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# <span style="color:#a2f">cd</span> /sys/fs/cgroup/memory/mydocker 
zhou# <span style="color:#a2f">echo</span> <span style="color:#666">1073741824</span> &gt; memory.limit_in_bytes
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建进程，加入cgroup</p>
<p>同样把当前shell进程ID写入tasks文件内：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# <span style="color:#a2f">cd</span> /sys/fs/cgroup/memory/mydocker 
zhou# <span style="color:#a2f">echo</span> <span style="color:#b8860b">$$</span> &gt; tasks
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>执行内存测试工具，申请内存</p>
<p>这里我们需要借助一下工具 memtester</p>
<p>安装memtester</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt-get install memtester
</code></pre></td></tr></table>
</div>
</div><p>执行如下命令：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# memtester 1500m <span style="color:#666">1</span>
memtester version 4.3.0 <span style="color:#666">(</span>64-bit<span style="color:#666">)</span>
Copyright <span style="color:#666">(</span>C<span style="color:#666">)</span> 2001-2012 Charles Cazabon.
Licensed under the GNU General Public License version <span style="color:#666">2</span> <span style="color:#666">(</span>only<span style="color:#666">)</span>.
   
pagesize is <span style="color:#666">4096</span>
pagesizemask is 0xfffffffffffff000
want 1500MB <span style="color:#666">(</span><span style="color:#666">1572864000</span> bytes<span style="color:#666">)</span>
got  1500MB <span style="color:#666">(</span><span style="color:#666">1572864000</span> bytes<span style="color:#666">)</span>, trying mlock ...zsh: killed     memtester 1500m <span style="color:#666">1</span>
</code></pre></td></tr></table>
</div>
</div><p>该命令会申请1500M内存，并且做内存测试。由于上面我们对当前shell进程内存限制为1G，当memtester使用的内存达到1G时，cgroup便会将memtester杀死。</p>
<p>上面最后一行的输出表示memtester想要1500M内存，但是由于cgroup的限制，达到内存使用上限，被杀死了，与预期一致。</p>
<p>我们可以使用以下命令，降低一下内存申请，将内存申请调整为500M:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zhou# memtester 500m <span style="color:#666">1</span> 
memtester version 4.3.0 <span style="color:#666">(</span>64-bit<span style="color:#666">)</span>
Copyright <span style="color:#666">(</span>C<span style="color:#666">)</span> 2001-2012 Charles Cazabon.
Licensed under the GNU General Public License version <span style="color:#666">2</span> <span style="color:#666">(</span>only<span style="color:#666">)</span>.
   
pagesize is <span style="color:#666">4096</span>
pagesizemask is 0xfffffffffffff000
want 500MB <span style="color:#666">(</span><span style="color:#666">524288000</span> bytes<span style="color:#666">)</span>
got  500MB <span style="color:#666">(</span><span style="color:#666">524288000</span> bytes<span style="color:#666">)</span>, trying mlock ...locked.
Loop 1/1:
  Stuck Address       : ok         
  Random Value        : ok
  Compare XOR         : ok
  Compare SUB         : ok
  Compare MUL         : ok
  Compare DIV         : ok
  Compare OR          : ok
  Compare AND         : ok
  Sequential Increment: ok
  Solid Bits          : ok         
  Block Sequential    : ok         
  Checkerboard        : ok         
  Bit Spread          : ok         
  Bit Flip            : ok         
  Walking Ones        : ok         
  Walking Zeroes      : ok         
  8-bit Writes        : ok
  16-bit Writes       : ok
   
Done.
</code></pre></td></tr></table>
</div>
</div><p>这里可以看到，此时memtester已经成功申请到500M内存并且正常完成了内存测试。</p>
</li>
</ol>
<h4 id="删除-cgroups">删除 cgroups</h4>
<p>上面创建的cgroup如果不想使用了，直接删除创建的文件夹即可。</p>
<p>例如想删除内存下的mydocker目录，使用以下命令即可：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ sudo rmdir /sys/fs/cgroup/memory/mydocker 
</code></pre></td></tr></table>
</div>
</div><h3 id="docker是如何使用cgroups的">Docker是如何使用cgroups的</h3>
<p>首先，我们使用以下命令创建一个 nginx 容器：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -it -m<span style="color:#666">=</span>1g nginx
</code></pre></td></tr></table>
</div>
</div><p>上述命令创建并启动了一个 nginx 容器，并且限制内存为 1G。然后我们进入 cgroups 内存子系统的目录，使用 ls 命令查看一下该目录下的内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ ls -l /sys/fs/cgroup/memory 
总用量 <span style="color:#666">0</span>
-rw-r--r--  <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 14:21 cgroup.clone_children
--w--w--w-  <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 14:21 cgroup.event_control
-rw-r--r--  <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 08:47 cgroup.procs
-r--r--r--  <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 14:21 cgroup.sane_behavior
drwxr-xr-x  <span style="color:#666">4</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 08:47 docker
......
</code></pre></td></tr></table>
</div>
</div><p>通过上面输出可以看到，该目录下有一个 docker 目录，该目录正是 Docker 在内存子系统下创建的。
我们进入到 docker 目录下查看一下相关内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ <span style="color:#a2f">cd</span> /sys/fs/cgroup/memory/docker
➜  docker ls -l                      
总用量 <span style="color:#666">0</span>
drwxr-xr-x <span style="color:#666">2</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 14:18 956ad357c45498d219a4d9bd0feae62b7cde5469790aa3afe764b948945237fa
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 14:23 cgroup.clone_children
--w--w--w- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 14:23 cgroup.event_control
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 14:23 cgroup.procs
......
-rw-r--r-- <span style="color:#666">1</span> root root <span style="color:#666">0</span> 6月  <span style="color:#666">16</span> 14:23 tasks

</code></pre></td></tr></table>
</div>
</div><p>可以看到 docker 的目录下有一个一串随机 ID 的目录，该目录即为我们上面创建的 nginx 容器的 ID。然后我们进入该目录，查看一下该容器的 memory.limit_in_bytes 文件的内容。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  docker <span style="color:#a2f">cd</span> 956ad357c45498d219a4d9bd0feae62b7cde5469790aa3afe764b948945237fa 
➜  956a...fa cat memory.limit_in_bytes 
<span style="color:#666">1073741824</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到内存限制值正好为 1G。
事实上，Docker 创建容器时，Docker 会根据启动容器的参数，在对应的 cgroups 子系统下创建以容器 ID 为名称的目录, 然后根据容器启动时设置的资源限制参数, 修改对应的 cgroups 子系统资源限制文件, 从而达到资源限制的效果。</p>
<h3 id="小结-1">小结</h3>
<p>cgroups不仅可以实现资源的限制，还可以为我们统计资源的使用情况，容器监控系统的数据来源也是cgroups提供的。</p>
<p>另外，cgroups虽然可以实现资源的限制，但是不能保证资源的使用。例如cgroups限制容器最多使用1核CPU，但不保证总是能使用1核CPU，当CPU资源发生竞争时，可能会导致实际上使用的CPU资源产生竞争。</p>
<h2 id="组件组成剖析docker组件作用及其底层工作原理">组件组成：剖析Docker组件作用及其底层工作原理</h2>
<h3 id="docker-的组件构成">Docker 的组件构成</h3>
<p>Docker 整体架构采用C/S模式，主要由客户端和服务端两大部分组成。客户端负责发送操作指令，服务端负责接收和处理指令。客户端和服务端通信由多种方式，即可以在同一台机器上通过<code>UNIX</code>套接字通信，也可以通过网络连接远程通信。</p>
<p><img src="https://s0.lgstatic.com/i/image/M00/56/40/CgqCHl9rFtSAPGOeAADIK4E6wrc522.png" alt=""></p>
<p>从整体架构可知，Docker 组件大体分为 Docker 相关组件，containerd 相关组件和容器运行时相关组件。下面我们深入剖析下各个组件。</p>
<h3 id="docker-组件剖析">Docker 组件剖析</h3>
<p>Docker 到底有哪些组件呢？我们可以在 Docker 安装路径下执行 ls 命令，这样可以看到以下与 Docker 有关的组件。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">containerd
containerd-shim
ctr
docker
docker-init
docker-proxy
dockerd
runc
</code></pre></td></tr></table>
</div>
</div><p>这些组件根据工作职责可以分为以下三大类：</p>
<ol>
<li>Docker相关的组件：docker、dockerd、docker-init和docker-proxy</li>
<li>containerd 相关的组件：containerd、containerd-shim 和 ctr</li>
<li>容器运行时相关组件：runc</li>
</ol>
<h3 id="docker相关组件">Docker相关组件</h3>
<ol>
<li>
<p><strong>docker</strong></p>
<p>docker是Docker客户端的一个完整实现，它是一个二进制文件，对用户可见的操作形式为docker命令，通过docker命令可以完成所有的Docker客户端与服务端的通信（还可以通过REST API、SDK 等多种形式与Docker服务端通信）</p>
<p>Docker 客户端与服务端的交互过程是：docker 组件向服务端发送请求后，服务端根据请求执行具体的动作并将结果返回给 docker，docker 解析服务端的返回结果，并将结果通过命令行标准输出展示给用户。这样一次完整的客户端服务端请求就完成了。</p>
</li>
<li>
<p><strong>dockerd</strong></p>
<p>dockerd 是 Docker 服务端的后台常驻进程，用来接收客户端发送的请求，执行具体的处理任务，处理完成后将结果返回给客户端。</p>
<p>Docker 客户端可以通过多种方式向 dockerd 发送请求，我们常用的 Docker 客户端与 dockerd 的交互方式有三种。</p>
<ul>
<li>通过 UNIX 套接字与服务端通信：配置格式为 unix://socket_path，默认 dockerd 生成的 socket 文件路径为 /var/run/docker.sock，该文件只有 root 用户或者 docker 用户组的用户才可以访问，这就是为什么 Docker 刚安装完成后只有 root 用户才能使用 docker 命令的原因。</li>
<li>通过 TCP 与服务端通信：配置格式为 tcp://host:port，通过这种方式可以实现客户端远程连接服务端，但是在方便的同时也带有安全隐患，因此在生产环境中如果你要使用 TCP 的方式与 Docker 服务端通信，推荐使用 TLS 认证，可以通过设置 Docker 的 TLS 相关参数，来保证数据传输的安全。</li>
<li>通过文件描述符的方式与服务端通信：配置格式为：fd:// 这种格式一般用于 systemd 管理的系统中。</li>
</ul>
<p>Docker 客户端和服务端的通信形式必须保持一致，否则将无法通信，只有当 dockerd 监听了 UNIX 套接字客户端才可以使用 UNIX 套接字的方式与服务端通信，UNIX 套接字也是 Docker 默认的通信方式，如果你想要通过远程的方式访问 dockerd，可以在 dockerd 启动的时候添加 -H 参数指定监听的 HOST 和 PORT。</p>
</li>
<li>
<p><strong>docker-init</strong></p>
<p>如果你熟悉 Linux 系统，你应该知道在 Linux 系统中，1 号进程是 init 进程，是所有进程的父进程。主机上的进程出现问题时，init 进程可以帮我们回收这些问题进程。同样的，在容器内部，当我们自己的业务进程没有回收子进程的能力时，在执行 docker run 启动容器时可以添加 &ndash;init 参数，此时 Docker 会使用 docker-init 作为 1 号进程，帮你管理容器内子进程，例如回收僵尸进程等。</p>
<p>下面我们通过启动一个 busybox 容器来演示下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ docker run -it busybox sh                               
/ <span style="color:#080;font-style:italic"># ps aux</span>
PID   USER     TIME  COMMAND
    <span style="color:#666">1</span> root      0:00 sh
    <span style="color:#666">7</span> root      0:00 ps aux
</code></pre></td></tr></table>
</div>
</div><p>可以看到容器启动时如果没有添加&ndash;init参数，1号进程就是sh进程</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ docker run -it --init busybox sh                        
/ <span style="color:#080;font-style:italic"># ps aux</span>
PID   USER     TIME  COMMAND
    <span style="color:#666">1</span> root      0:00 /sbin/docker-init -- sh
    <span style="color:#666">8</span> root      0:00 sh
    <span style="color:#666">9</span> root      0:00 ps aux
</code></pre></td></tr></table>
</div>
</div><p>可以看到此时容器内的1号进程已经编程了/sbin/docker-init，而不再是sh了</p>
</li>
<li>
<p>docker-proxy</p>
<p>docker-proxy 主要是用来做端口映射的。当我们使用 docker run 命令启动容器时，如果使用了 -p 参数，docker-proxy 组件就会把容器内相应的端口映射到主机上来，底层是依赖于 iptables 实现的。</p>
<p>下面我们通过一个实例演示下</p>
<p>使用以下命令启动一个 nginx 容器并把容器的 80 端口映射到主机的 8080 端口。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ docker run --name<span style="color:#666">=</span>nginx -d -p 8080:80 nginx  
</code></pre></td></tr></table>
</div>
</div><p>然后通过以下命令查看以下启动的容器IP：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ docker inspect --format <span style="color:#b44">&#39;{{ .NetworkSettings.IPAddress }}&#39;</span> nginx
172.17.0.3
</code></pre></td></tr></table>
</div>
</div><p>可以看到，我们启动的nginx容器IP为 172.17.0.3</p>
<p>此时，我们使用ps命令查看一下主机上是否有docker-proxy进程：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ sudo ps aux |grep docker-proxy
root        <span style="color:#666">2416</span>  0.0  0.0 <span style="color:#666">549664</span>  <span style="color:#666">3220</span> ?        Sl   14:54   0:00 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port <span style="color:#666">9000</span> -container-ip 172.17.0.2 -container-port <span style="color:#666">9000</span>
root        <span style="color:#666">2429</span>  0.0  0.0 <span style="color:#666">474524</span>  <span style="color:#666">2784</span> ?        Sl   14:54   0:00 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port <span style="color:#666">8000</span> -container-ip 172.17.0.2 -container-port <span style="color:#666">8000</span>
root       <span style="color:#666">58293</span>  0.0  0.0 <span style="color:#666">474524</span>  <span style="color:#666">2828</span> ?        Sl   18:37   0:00 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port <span style="color:#666">8080</span> -container-ip 172.17.0.3 -container-port <span style="color:#666">80</span>
zhou       <span style="color:#666">59122</span>  0.0  0.0  <span style="color:#666">12136</span>  <span style="color:#666">2480</span> pts/3    S+   18:40   0:00 grep --color<span style="color:#666">=</span>auto --exclude-dir<span style="color:#666">=</span>.bzr --exclude-dir<span style="color:#666">=</span>CVS --exclude-dir<span style="color:#666">=</span>.git --exclude-dir<span style="color:#666">=</span>.hg --exclude-dir<span style="color:#666">=</span>.svn --exclude-dir<span style="color:#666">=</span>.idea --exclude-dir<span style="color:#666">=</span>.tox docker-proxy
</code></pre></td></tr></table>
</div>
</div><p>可以看到当我们启动一个容器时需要端口映射时， Docker 为我们创建了一个 docker-proxy 进程，并且通过参数把我们的容器 IP 和端口传递给 docker-proxy 进程，然后 docker-proxy 通过 iptables 实现了 nat 转发。</p>
<p>我们通过一下命令查看一下主机iptables nat表的规则：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ sudo iptables -L -nv -t nat          
Chain PREROUTING <span style="color:#666">(</span>policy ACCEPT <span style="color:#666">31</span> packets, <span style="color:#666">5763</span> bytes<span style="color:#666">)</span>
 pkts bytes target     prot opt in     out     <span style="color:#a2f">source</span>               destination         
   <span style="color:#666">43</span>  <span style="color:#666">2891</span> DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL
   
Chain INPUT <span style="color:#666">(</span>policy ACCEPT <span style="color:#666">31</span> packets, <span style="color:#666">5763</span> bytes<span style="color:#666">)</span>
 pkts bytes target     prot opt in     out     <span style="color:#a2f">source</span>               destination         
   
Chain OUTPUT <span style="color:#666">(</span>policy ACCEPT <span style="color:#666">117</span> packets, <span style="color:#666">13371</span> bytes<span style="color:#666">)</span>
 pkts bytes target     prot opt in     out     <span style="color:#a2f">source</span>               destination         
    <span style="color:#666">0</span>     <span style="color:#666">0</span> DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL
   
Chain POSTROUTING <span style="color:#666">(</span>policy ACCEPT <span style="color:#666">117</span> packets, <span style="color:#666">13371</span> bytes<span style="color:#666">)</span>
 pkts bytes target     prot opt in     out     <span style="color:#a2f">source</span>               destination         
    <span style="color:#666">0</span>     <span style="color:#666">0</span> MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0           
 <span style="color:#666">6307</span>  706K LIBVIRT_PRT  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    <span style="color:#666">0</span>     <span style="color:#666">0</span> MASQUERADE  tcp  --  *      *       172.17.0.2           172.17.0.2           tcp dpt:9000
    <span style="color:#666">0</span>     <span style="color:#666">0</span> MASQUERADE  tcp  --  *      *       172.17.0.2           172.17.0.2           tcp dpt:8000
    <span style="color:#666">0</span>     <span style="color:#666">0</span> MASQUERADE  tcp  --  *      *       172.17.0.3           172.17.0.3           tcp dpt:80
   
Chain DOCKER <span style="color:#666">(</span><span style="color:#666">2</span> references<span style="color:#666">)</span>
 pkts bytes target     prot opt in     out     <span style="color:#a2f">source</span>               destination         
    <span style="color:#666">0</span>     <span style="color:#666">0</span> RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0           
    <span style="color:#666">0</span>     <span style="color:#666">0</span> DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:9000 to:172.17.0.2:9000
    <span style="color:#666">0</span>     <span style="color:#666">0</span> DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8000 to:172.17.0.2:8000
    <span style="color:#666">0</span>     <span style="color:#666">0</span> DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 to:172.17.0.3:80
</code></pre></td></tr></table>
</div>
</div><p>通过最后一行规则我们可以得知，当我们访问主机的 8080 端口时，iptables 会把流量转发到 172.17.0.3 的 80 端口，从而实现了我们从主机上可以直接访问到容器内的业务。</p>
<p>我们通过curl命令访问一下nginx容器：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ curl http://localhost:8080     
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body <span style="color:#666">{</span>
        width: 35em;
        margin: <span style="color:#666">0</span> auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    <span style="color:#666">}</span>
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;
   
&lt;p&gt;For online documentation and support please refer to
&lt;a <span style="color:#b8860b">href</span><span style="color:#666">=</span><span style="color:#b44">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a <span style="color:#b8860b">href</span><span style="color:#666">=</span><span style="color:#b44">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
   
&lt;p&gt;&lt;em&gt;Thank you <span style="color:#a2f;font-weight:bold">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></td></tr></table>
</div>
</div><p>通过上面的输出可以得知我们已经成功访问到了 nginx 容器。</p>
<p>总体来说，docker 是官方实现的标准客户端，dockerd 是 Docker 服务端的入口，负责接收客户端发送的指令并返回相应结果，而 docker-init 在业务主进程没有进程回收功能时则十分有用，docker-proxy 组件则是实现 Docker 网络访问的重要组件。</p>
<h3 id="containerd-相关组件">containerd 相关组件</h3>
<ol>
<li>
<p><strong>containerd</strong></p>
<p><a href="https://github.com/containerd/containerd">containerd</a> 组件是从 Docker 1.11 版本正式从 dockerd 中剥离出来的，它的诞生完全遵循 OCI 标准，是容器标准化后的产物。containerd 完全遵循了 OCI 标准，并且是完全社区化运营的，因此被容器界广泛采用。</p>
<p>containerd 不仅负责容器生命周期的管理，同时还负责一些其他的功能：</p>
<ul>
<li>镜像的管理，例如容器运行前从镜像仓库拉取镜像到本地；</li>
<li>接收dockerd的请求，通过适当的参数调用runc启动容器；</li>
<li>管理存储相关资源</li>
<li>管理网络相关资源</li>
</ul>
<p>containerd 包含一个后台常驻进程，默认的 socket 路径为 /run/containerd/containerd.sock，dockerd 通过 UNIX 套接字向 containerd 发送请求，containerd 接收到请求后负责执行相关的动作并把执行结果返回给 dockerd。</p>
<p>如果你不想使用 dockerd，也可以直接使用 containerd 来管理容器，由于 containerd 更加简单和轻量，生产环境中越来越多的人开始直接使用 containerd 来管理容器。</p>
</li>
<li>
<p><strong>containerd-shim</strong></p>
<p>containerd-shim 的意思是垫片，类似于拧螺丝时夹在螺丝和螺母之间的垫片。containerd-shim 的主要作用是将 containerd 和真正的容器进程解耦，使用 containerd-shim 作为容器进程的父进程，从而实现重启 containerd 不影响已经启动的容器进程。</p>
</li>
<li>
<p><strong>ctr</strong></p>
<p>ctr 实际上是 containerd-ctr，它是 containerd 的客户端，主要用来开发和调试，在没有 dockerd 的环境中，ctr 可以充当 docker 客户端的部分角色，直接向 containerd 守护进程发送操作容器的请求。</p>
<p>了解完 containerd 相关的组件，我们来了解一下容器的真正运行时 runc。</p>
</li>
</ol>
<h3 id="容器运行时组件runc">容器运行时组件runc</h3>
<p>runc 是一个标准的 OCI 容器运行时的实现，它是一个命令行工具，可以直接用来创建和运行容器。</p>
<p>下面我们通过一个实例来演示一下 runc 的神奇之处。</p>
<p>第一步，准备容器运行时文件：进入 /home/centos 目录下，创建 runc 文件夹，并导入 busybox 镜像文件。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#a2f">cd</span> /home/centos
 <span style="color:#080;font-style:italic">## 创建 runc 运行根目录</span>
$ mkdir runc
 <span style="color:#080;font-style:italic">## 导入 rootfs 镜像文件</span>
$ mkdir rootfs <span style="color:#666">&amp;&amp;</span> docker <span style="color:#a2f">export</span> <span style="color:#a2f;font-weight:bold">$(</span>docker create busybox<span style="color:#a2f;font-weight:bold">)</span> | tar -C rootfs -xvf -
</code></pre></td></tr></table>
</div>
</div><p>第二步，生成 runc config 文件。我们可以使用 runc spec 命令根据文件系统生成对应的 config.json 文件。命令如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ runc spec
</code></pre></td></tr></table>
</div>
</div><p>此时会在当前目录下生成 config.json 文件，我们可以使用 cat 命令查看一下 config.json 的内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ cat config.json 
<span style="color:#666">{</span>
 <span style="color:#b44">&#34;ociVersion&#34;</span>: <span style="color:#b44">&#34;1.0.2-dev&#34;</span>,
 <span style="color:#b44">&#34;process&#34;</span>: <span style="color:#666">{</span>
     <span style="color:#b44">&#34;terminal&#34;</span>: true,
     <span style="color:#b44">&#34;user&#34;</span>: <span style="color:#666">{</span>
         <span style="color:#b44">&#34;uid&#34;</span>: 0,
         <span style="color:#b44">&#34;gid&#34;</span>: <span style="color:#666">0</span>
     <span style="color:#666">}</span>,
     <span style="color:#b44">&#34;args&#34;</span>: <span style="color:#666">[</span>
         <span style="color:#b44">&#34;sh&#34;</span>
     <span style="color:#666">]</span>,
     <span style="color:#b44">&#34;env&#34;</span>: <span style="color:#666">[</span>
         <span style="color:#b44">&#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span>,
         <span style="color:#b44">&#34;TERM=xterm&#34;</span>
     <span style="color:#666">]</span>,
     <span style="color:#b44">&#34;cwd&#34;</span>: <span style="color:#b44">&#34;/&#34;</span>,
     <span style="color:#b44">&#34;capabilities&#34;</span>: <span style="color:#666">{</span>
         <span style="color:#b44">&#34;bounding&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;CAP_AUDIT_WRITE&#34;</span>,
             <span style="color:#b44">&#34;CAP_KILL&#34;</span>,
             <span style="color:#b44">&#34;CAP_NET_BIND_SERVICE&#34;</span>
         <span style="color:#666">]</span>,
         <span style="color:#b44">&#34;effective&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;CAP_AUDIT_WRITE&#34;</span>,
             <span style="color:#b44">&#34;CAP_KILL&#34;</span>,
             <span style="color:#b44">&#34;CAP_NET_BIND_SERVICE&#34;</span>
         <span style="color:#666">]</span>,
         <span style="color:#b44">&#34;inheritable&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;CAP_AUDIT_WRITE&#34;</span>,
             <span style="color:#b44">&#34;CAP_KILL&#34;</span>,
             <span style="color:#b44">&#34;CAP_NET_BIND_SERVICE&#34;</span>
         <span style="color:#666">]</span>,
         <span style="color:#b44">&#34;permitted&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;CAP_AUDIT_WRITE&#34;</span>,
             <span style="color:#b44">&#34;CAP_KILL&#34;</span>,
             <span style="color:#b44">&#34;CAP_NET_BIND_SERVICE&#34;</span>
         <span style="color:#666">]</span>,
         <span style="color:#b44">&#34;ambient&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;CAP_AUDIT_WRITE&#34;</span>,
             <span style="color:#b44">&#34;CAP_KILL&#34;</span>,
             <span style="color:#b44">&#34;CAP_NET_BIND_SERVICE&#34;</span>
         <span style="color:#666">]</span>
     <span style="color:#666">}</span>,
     <span style="color:#b44">&#34;rlimits&#34;</span>: <span style="color:#666">[</span>
         <span style="color:#666">{</span>
             <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;RLIMIT_NOFILE&#34;</span>,
             <span style="color:#b44">&#34;hard&#34;</span>: 1024,
             <span style="color:#b44">&#34;soft&#34;</span>: <span style="color:#666">1024</span>
         <span style="color:#666">}</span>
     <span style="color:#666">]</span>,
     <span style="color:#b44">&#34;noNewPrivileges&#34;</span>: <span style="color:#a2f">true</span>
 <span style="color:#666">}</span>,
 <span style="color:#b44">&#34;root&#34;</span>: <span style="color:#666">{</span>
     <span style="color:#b44">&#34;path&#34;</span>: <span style="color:#b44">&#34;rootfs&#34;</span>,
     <span style="color:#b44">&#34;readonly&#34;</span>: <span style="color:#a2f">true</span>
 <span style="color:#666">}</span>,
 <span style="color:#b44">&#34;hostname&#34;</span>: <span style="color:#b44">&#34;runc&#34;</span>,
 <span style="color:#b44">&#34;mounts&#34;</span>: <span style="color:#666">[</span>
     <span style="color:#666">{</span>
         <span style="color:#b44">&#34;destination&#34;</span>: <span style="color:#b44">&#34;/proc&#34;</span>,
         <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;proc&#34;</span>,
         <span style="color:#b44">&#34;source&#34;</span>: <span style="color:#b44">&#34;proc&#34;</span>
     <span style="color:#666">}</span>,
     <span style="color:#666">{</span>
         <span style="color:#b44">&#34;destination&#34;</span>: <span style="color:#b44">&#34;/dev&#34;</span>,
         <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;tmpfs&#34;</span>,
         <span style="color:#b44">&#34;source&#34;</span>: <span style="color:#b44">&#34;tmpfs&#34;</span>,
         <span style="color:#b44">&#34;options&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;nosuid&#34;</span>,
             <span style="color:#b44">&#34;strictatime&#34;</span>,
             <span style="color:#b44">&#34;mode=755&#34;</span>,
             <span style="color:#b44">&#34;size=65536k&#34;</span>
         <span style="color:#666">]</span>
     <span style="color:#666">}</span>,
     <span style="color:#666">{</span>
         <span style="color:#b44">&#34;destination&#34;</span>: <span style="color:#b44">&#34;/dev/pts&#34;</span>,
         <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;devpts&#34;</span>,
         <span style="color:#b44">&#34;source&#34;</span>: <span style="color:#b44">&#34;devpts&#34;</span>,
         <span style="color:#b44">&#34;options&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;nosuid&#34;</span>,
             <span style="color:#b44">&#34;noexec&#34;</span>,
             <span style="color:#b44">&#34;newinstance&#34;</span>,
             <span style="color:#b44">&#34;ptmxmode=0666&#34;</span>,
             <span style="color:#b44">&#34;mode=0620&#34;</span>,
             <span style="color:#b44">&#34;gid=5&#34;</span>
         <span style="color:#666">]</span>
     <span style="color:#666">}</span>,
     <span style="color:#666">{</span>
         <span style="color:#b44">&#34;destination&#34;</span>: <span style="color:#b44">&#34;/dev/shm&#34;</span>,
         <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;tmpfs&#34;</span>,
         <span style="color:#b44">&#34;source&#34;</span>: <span style="color:#b44">&#34;shm&#34;</span>,
         <span style="color:#b44">&#34;options&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;nosuid&#34;</span>,
             <span style="color:#b44">&#34;noexec&#34;</span>,
             <span style="color:#b44">&#34;nodev&#34;</span>,
             <span style="color:#b44">&#34;mode=1777&#34;</span>,
             <span style="color:#b44">&#34;size=65536k&#34;</span>
         <span style="color:#666">]</span>
     <span style="color:#666">}</span>,
     <span style="color:#666">{</span>
         <span style="color:#b44">&#34;destination&#34;</span>: <span style="color:#b44">&#34;/dev/mqueue&#34;</span>,
         <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;mqueue&#34;</span>,
         <span style="color:#b44">&#34;source&#34;</span>: <span style="color:#b44">&#34;mqueue&#34;</span>,
         <span style="color:#b44">&#34;options&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;nosuid&#34;</span>,
             <span style="color:#b44">&#34;noexec&#34;</span>,
             <span style="color:#b44">&#34;nodev&#34;</span>
         <span style="color:#666">]</span>
     <span style="color:#666">}</span>,
     <span style="color:#666">{</span>
         <span style="color:#b44">&#34;destination&#34;</span>: <span style="color:#b44">&#34;/sys&#34;</span>,
         <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;sysfs&#34;</span>,
         <span style="color:#b44">&#34;source&#34;</span>: <span style="color:#b44">&#34;sysfs&#34;</span>,
         <span style="color:#b44">&#34;options&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;nosuid&#34;</span>,
             <span style="color:#b44">&#34;noexec&#34;</span>,
             <span style="color:#b44">&#34;nodev&#34;</span>,
             <span style="color:#b44">&#34;ro&#34;</span>
         <span style="color:#666">]</span>
     <span style="color:#666">}</span>,
     <span style="color:#666">{</span>
         <span style="color:#b44">&#34;destination&#34;</span>: <span style="color:#b44">&#34;/sys/fs/cgroup&#34;</span>,
         <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;cgroup&#34;</span>,
         <span style="color:#b44">&#34;source&#34;</span>: <span style="color:#b44">&#34;cgroup&#34;</span>,
         <span style="color:#b44">&#34;options&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#b44">&#34;nosuid&#34;</span>,
             <span style="color:#b44">&#34;noexec&#34;</span>,
             <span style="color:#b44">&#34;nodev&#34;</span>,
             <span style="color:#b44">&#34;relatime&#34;</span>,
             <span style="color:#b44">&#34;ro&#34;</span>
         <span style="color:#666">]</span>
     <span style="color:#666">}</span>
 <span style="color:#666">]</span>,
 <span style="color:#b44">&#34;linux&#34;</span>: <span style="color:#666">{</span>
     <span style="color:#b44">&#34;resources&#34;</span>: <span style="color:#666">{</span>
         <span style="color:#b44">&#34;devices&#34;</span>: <span style="color:#666">[</span>
             <span style="color:#666">{</span>
                 <span style="color:#b44">&#34;allow&#34;</span>: false,
                 <span style="color:#b44">&#34;access&#34;</span>: <span style="color:#b44">&#34;rwm&#34;</span>
             <span style="color:#666">}</span>
         <span style="color:#666">]</span>
     <span style="color:#666">}</span>,
     <span style="color:#b44">&#34;namespaces&#34;</span>: <span style="color:#666">[</span>
         <span style="color:#666">{</span>
             <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;pid&#34;</span>
         <span style="color:#666">}</span>,
         <span style="color:#666">{</span>
             <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;network&#34;</span>
         <span style="color:#666">}</span>,
         <span style="color:#666">{</span>
             <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;ipc&#34;</span>
         <span style="color:#666">}</span>,
         <span style="color:#666">{</span>
             <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;uts&#34;</span>
         <span style="color:#666">}</span>,
         <span style="color:#666">{</span>
             <span style="color:#b44">&#34;type&#34;</span>: <span style="color:#b44">&#34;mount&#34;</span>
         <span style="color:#666">}</span>
     <span style="color:#666">]</span>,
     <span style="color:#b44">&#34;maskedPaths&#34;</span>: <span style="color:#666">[</span>
         <span style="color:#b44">&#34;/proc/acpi&#34;</span>,
         <span style="color:#b44">&#34;/proc/asound&#34;</span>,
         <span style="color:#b44">&#34;/proc/kcore&#34;</span>,
         <span style="color:#b44">&#34;/proc/keys&#34;</span>,
         <span style="color:#b44">&#34;/proc/latency_stats&#34;</span>,
         <span style="color:#b44">&#34;/proc/timer_list&#34;</span>,
         <span style="color:#b44">&#34;/proc/timer_stats&#34;</span>,
         <span style="color:#b44">&#34;/proc/sched_debug&#34;</span>,
         <span style="color:#b44">&#34;/sys/firmware&#34;</span>,
         <span style="color:#b44">&#34;/proc/scsi&#34;</span>
     <span style="color:#666">]</span>,
     <span style="color:#b44">&#34;readonlyPaths&#34;</span>: <span style="color:#666">[</span>
         <span style="color:#b44">&#34;/proc/bus&#34;</span>,
         <span style="color:#b44">&#34;/proc/fs&#34;</span>,
         <span style="color:#b44">&#34;/proc/irq&#34;</span>,
         <span style="color:#b44">&#34;/proc/sys&#34;</span>,
         <span style="color:#b44">&#34;/proc/sysrq-trigger&#34;</span>
     <span style="color:#666">]</span>
 <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>config.json 文件定义了 runc 启动容器时的一些配置，如根目录的路径，文件挂载路径等配置。</p>
<p>第三步，使用 runc 启动容器。我们可以使用 runc run 命令直接启动 busybox 容器。</p>
<p>此时，我们已经创建并启动了一个 busybox 容器。</p>
<p>我们新打开一个命令行窗口，可以使用 run list 命令看到刚才启动的容器。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#a2f">cd</span> /home/centos/runc/
$ runc list
D          PID         STATUS      BUNDLE              CREATED                          OWNER
busybox     9778        running     /home/centos/runc   2020-09-06T09:25:32.441957273Z   root
</code></pre></td></tr></table>
</div>
</div><p>通过上面的输出，我们可以看到，当前已经有一个 busybox 容器处于运行状态。</p>
<p>总体来说，Docker 的组件虽然很多，但每个组件都有自己清晰的工作职责，Docker 相关的组件负责发送和接受 Docker 请求，contianerd 相关的组件负责管理容器的生命周期，而 runc 负责真正意义上创建和启动容器。这些组件相互配合，才使得 Docker 顺利完成了容器的管理工作。</p>
<h3 id="总结">总结</h3>
<p><img src="https://s0.lgstatic.com/i/image/M00/59/E6/Ciqc1F9y4vGAVzmAAADk1nlHpUA424.png" alt=""></p>
</li>
</ol>
<h2 id="网络模型剖析docker网络实现及libnetwork底层原理">网络模型：剖析Docker网络实现及Libnetwork底层原理</h2>
<p>利用Namespace和Cgroups技术，利用这两项技术可以实现各种资源的隔离和主机资源的限制，让我们的容器可以像一台虚拟机一样。但这是我们的容器就像一台未联网的电脑，不能被外部访问到，也不能主动与外部通信，这样的容器只能做一些离线的处理任务，无法通过外部访问。</p>
<h3 id="容器网络发展史">容器网络发展史</h3>
<p>提起 Docker 网络，我们不得不从容器战争说起。Docker 从 2013 年诞生，到后来逐渐成为了容器的代名词，然而 Docker 的野心也不止于此，它还想在更多的领域独占鳌头，比如制定容器的网络和存储标准。</p>
<p>于是 Docker 从 1.7 版本开始，便把网络和存储从 Docker 中正式以插件的形式剥离开来，并且分别为其定义了标准，Docker 定义的网络模型标准称之为 CNM (Container Network Model) 。</p>
<blockquote>
<p>Docker 推出 CNM 的同时，CoreOS 推出了 CNI。起初，以 Kubernetes 为代表的容器编排阵营考虑过使用 CNM 作为容器的网络标准，但是后来由于很多技术和非技术原因（如果你对详细原因感兴趣，可以参考这篇博客），Kubernetes 决定支持 CoreOS 推出的容器网络标准 CNI。</p>
</blockquote>
<p>从此，容器的网络标准便分为两大阵营，一个是以 Docker 公司为代表的 CNM，另一个便是以 Google、Kubernetes、CoreOS 为代表的 CNI 网络标准。</p>
<h3 id="cnm">CNM</h3>
<p>CNM (Container Network Model) 是 Docker 发布的容器网络标准，意在规范和指定容器网络发展标准，CNM 抽象了容器的网络接口 ，使得只要满足 CNM 接口的网络方案都可以接入到 Docker 容器网络，更好地满足了用户网络模型多样化的需求。</p>
<p>CNM 只是定义了网络标准，对于底层的具体实现并不太关心，这样便解耦了容器和网络，使得容器的网络模型更加灵活。</p>
<p>CNM 定义的网络标准包含三个重要元素。</p>
<ul>
<li>
<p><strong>沙箱（Sandbox）</strong>：沙箱代表了一系列网络堆栈的配置，其中包含路由信息、网络接口等网络资源的管理，沙箱的实现通常是 Linux 的 Net Namespace，但也可以通过其他技术来实现，比如 <a href="https://zh.wikipedia.org/wiki/FreeBSD_jail">FreeBSD jail</a> 等。</p>
</li>
<li>
<p><strong>接入点（Endpoint）</strong>：接入点将沙箱连接到网络中，代表容器的网络接口，接入点的实现通常是 Linux 的 veth 设备对。</p>
</li>
<li>
<p><strong>网络（Network</strong>）：网络是一组可以互相通信的接入点，它将多接入点组成一个子网，并且多个接入点之间可以相互通信。</p>
</li>
</ul>
<p>CNM 的三个要素基本抽象了所有网络模型，使得网络模型的开发更加规范。</p>
<p>为了更好地构建容器网络标准，Docker 团队把网络功能从 Docker 中剥离出来，成为独立的项目 libnetwork，它通过插件的形式为 Docker 提供网络功能。Libnetwork 是开源的，使用 Golang 编写，它完全遵循 CNM 网络规范，是 CNM 的官方实现。Libnetwork 的工作流程也是完全围绕 CNM 的三个要素进行的，下面我们来详细了解一下 Libnetwork 是如何围绕 CNM 的三要素工作的。</p>
<h3 id="libnetwork-的工作流程">Libnetwork 的工作流程</h3>
<p>Libnetwork 是 Docker 启动容器时，用来为 Docker 容器提供网络接入功能的插件，它可以让 Docker 容器顺利接入网络，实现主机和容器网络的互通。下面，我们来详细了解一下 Libnetwork 是如何为 Docker 容器提供网络的。</p>
<p>第一步：Docker 通过调用 libnetwork.New 函数来创建 NetworkController 实例。NetworkController 是一个接口类型，提供了各种接口，代码如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a2f;font-weight:bold">type</span> NetworkController <span style="color:#a2f;font-weight:bold">interface</span> {
   <span style="color:#00a000">NewNetwork</span>(networkType, name <span style="color:#0b0;font-weight:bold">string</span>, id <span style="color:#0b0;font-weight:bold">string</span>, options <span style="color:#666">...</span>NetworkOption) (Network, <span style="color:#0b0;font-weight:bold">error</span>)
}

</code></pre></td></tr></table>
</div>
</div><p>第二步：通过调用 NewNetwork 函数创建指定名称和类型的 Network，其中 Network 也是接口类型，代码如下:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a2f;font-weight:bold">type</span> Network <span style="color:#a2f;font-weight:bold">interface</span> {
   <span style="color:#00a000">CreateEndpoint</span>(name <span style="color:#0b0;font-weight:bold">string</span>, options <span style="color:#666">...</span>EndpointOption) (Endpoint, <span style="color:#0b0;font-weight:bold">error</span>)
   <span style="color:#00a000">Delete</span>() <span style="color:#0b0;font-weight:bold">error</span>
}
</code></pre></td></tr></table>
</div>
</div><p>第三步：通过调用 CreateEndpoint 来创建接入点（Endpoint）。在 CreateEndpoint 函数中为容器分配了 IP 和网卡接口。其中 Endpoint 也是接口类型，代码如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a2f;font-weight:bold">type</span> Endpoint <span style="color:#a2f;font-weight:bold">interface</span> {
   <span style="color:#00a000">Join</span>(sandbox Sandbox, options <span style="color:#666">...</span>EndpointOption) <span style="color:#0b0;font-weight:bold">error</span>
   <span style="color:#00a000">Delete</span>(force <span style="color:#0b0;font-weight:bold">bool</span>) <span style="color:#0b0;font-weight:bold">error</span>
}
</code></pre></td></tr></table>
</div>
</div><p>第四步：调用 NewSandbox 来创建容器沙箱，主要是初始化 Namespace 相关的资源。</p>
<p>第五步：调用 Endpoint 的 Join 函数将沙箱和网络接入点关联起来，此时容器就加入了 Docker 网络并具备了网络访问能力。</p>
<p>Libnetwork 基于以上工作流程可以构建出多种网络模式，以满足我们的在不同场景下的需求，下面我们来详细了解一下 Libnetwork 提供的常见的四种网络模式。</p>
<h3 id="libnetwork-常见网络模式">Libnetwork 常见网络模式</h3>
<p>Libnetwork 比较典型的网络模式主要有四种，这四种网络模式基本满足了我们单机容器的所有场景。</p>
<ol>
<li>null 空网络模式：可以帮助我们构建一个没有网络接入的容器环境，以保障数据安全。</li>
<li>bridge 桥接模式：可以打通容器与容器间网络通信的需求。</li>
<li>host 主机网络模式：可以让容器内的进程共享主机网络，从而监听或修改主机网络。</li>
<li>container 网络模式：可以将两个容器放在同一个网络命名空间内，让两个业务通过 localhost 即可实现访问。</li>
</ol>
<p>下面我们对 libnetwork 的四种网络模式逐一讲解：</p>
<h4 id="null-空网络模式">null 空网络模式</h4>
<p>有时候，我们需要处理一些保密数据，出于安全考虑，我们需要一个隔离的网络环境执行一些纯计算任务。这时候 null 网络模式就派上用场了，这时候我们的容器就像一个没有联网的电脑，处于一个相对较安全的环境，确保我们的数据不被他人从网络窃取。</p>
<p>使用 Docker 创建 null 空网络模式的容器时，容器拥有自己独立的 Net Namespace，但是此时的容器并没有任何网络配置。在这种模式下，Docker 除了为容器创建了 Net Namespace 外，没有创建任何网卡接口、IP 地址、路由等网络配置。我们可以一起来验证下。</p>
<p>我们使用 <code>docker run</code> 命令启动时，添加 &ndash;net=none 参数启动一个空网络模式的容器，命令如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run --net<span style="color:#666">=</span>none -it busybox
/ #
</code></pre></td></tr></table>
</div>
</div><p>容器启动后，我们使用<code>ifconfig</code>命令查看以下容器内网络配置信息：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/ <span style="color:#080;font-style:italic"># ifconfig</span>
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 <span style="color:#666">(</span>0.0 B<span style="color:#666">)</span>  TX bytes:0 <span style="color:#666">(</span>0.0 B<span style="color:#666">)</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到容器内除了 Net Namespace 自带的 lo 网卡并没有创建任何虚拟网卡，然后我们再使用 <code>route -n</code> 命令查看一下容器内的路由信息:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/ <span style="color:#080;font-style:italic"># route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</code></pre></td></tr></table>
</div>
</div><p>可以看到，容器内也并没有配置任何路由信息。</p>
<h4 id="bridge-桥接模式">bridge 桥接模式</h4>
<p>Docker 的 bridge 网络是启动容器时默认的网络模式，使用 bridge 网络可以实现容器与容器的互通，可以从一个容器直接通过容器 IP 访问到另外一个容器。同时使用 bridge 网络可以实现主机与容器的互通，我们在容器内启动的业务，可以从主机直接请求。</p>
<p>在介绍 Docker 的 bridge 桥接模式前，我们需要先了解一下 Linux 的 veth 和 bridge 相关的技术，因为 Docker 的 bridge 模式正是由这两种技术实现的。</p>
<ul>
<li>
<p>Linux veth</p>
<p>veth是Linux中的虚拟设备接口，veth都是成对出现的，它在容器中，通常充当一个桥梁。veth可以用来连接虚拟网络设备，例如veth可以用来连通两个Net Namespace， 从而使得两个Net Namespace之间可以互相访问。</p>
</li>
<li>
<p>Linux bridge</p>
<p>Linux bridge 是一个虚拟设备，用来连接网络设备，相当于物理网络环境的<strong>交换机</strong>。Linux bridge可以用来转发两个Net Namespace内的流量</p>
</li>
<li>
<p>veth 与 bridge 的关系</p>
<p><img src="https://s0.lgstatic.com/i/image/M00/59/ED/Ciqc1F9y8IKAa-1NAABjDM-2kBk665.png" alt=""></p>
<p>通过该图，我们可以看到，bridge就像一台交换机，而veth就像一根网线，通过交换机和网线可以把两个不同Net Namespace 的容器连通，使得它们可以互相通信。</p>
<p>Docker 的 bridge 模式也是这种原理。Docker 启动时，libnetwork 会在主机上创建 docker0 网桥，docker0 网桥就相当于图 1 中的交换机，而 Docker 创建出的 brige 模式的容器则都会连接 docker0 上，从而实现网络互通。</p>
<p><strong>bridge 桥接模式是 Docker 的默认网络模式，当我们创建容器时不指定任何网络模式，Docker 启动容器默认的网络模式为 bridge。</strong></p>
</li>
</ul>
<h4 id="host-主机网络模式">host 主机网络模式</h4>
<p>容器内的网络并不是希望永远跟主机是隔离的，有些基础业务需要创建或更新主机的网络配置，我们的程序必须以主机网络模式运行才能修改主机网络，这时候就需要用到Docker 的 host 主机网络模式。</p>
<p>使用host主机网络模式时：</p>
<ul>
<li>Libnetwork 不会为容器创建新的网络配置和Net Namespace</li>
<li>Docker容器中的进程直接共享主机的网络配置，可以直接使用主机的网络信息，此时，在容器内监听的端口，也将直接占用到主机的端口</li>
<li>除了网络共享主机的网络外，其他的包括进程、文件系统、主机名等都是与主机隔离的</li>
</ul>
<p>host 主机网络模式通常适用于想要使用主机网络，但又不想把运行环境直接安装到主机上的场景中。例如我想在主机上运行一个 busybox 服务，但又不想直接把 busybox 安装到主机上污染主机环境，此时我可以使用以下命令启动一个主机网络模式的 busybox 镜像：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run -it --net<span style="color:#666">=</span>host busybox
/ #
</code></pre></td></tr></table>
</div>
</div><p>然后我们使用<code>ip a</code>命令查看一下容器内的网络环境：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/ <span style="color:#080;font-style:italic"># ip a</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#666">65536</span> qdisc noqueue qlen <span style="color:#666">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp2s0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span style="color:#666">1500</span> qdisc fq_codel qlen <span style="color:#666">1000</span>
    link/ether f4:8e:38:f5:82:01 brd ff:ff:ff:ff:ff:ff
3: wlp3s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#666">1500</span> qdisc noqueue qlen <span style="color:#666">1000</span>
    link/ether f8:34:41:be:1f:9f brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.42/24 brd 192.168.1.255 scope global dynamic noprefixroute wlp3s0
       valid_lft 79675sec preferred_lft 79675sec
    inet6 fe80::8d88:83cf:fa45:be94/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span style="color:#666">1500</span> qdisc noqueue qlen <span style="color:#666">1000</span>
    link/ether 52:54:00:b0:d3:cd brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu <span style="color:#666">1500</span> qdisc fq_codel master virbr0 qlen <span style="color:#666">1000</span>
    link/ether 52:54:00:b0:d3:cd brd ff:ff:ff:ff:ff:ff
6: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#666">1500</span> qdisc noqueue 
    link/ether 02:42:8a:36:20:6a brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:8aff:fe36:206a/64 scope link 
       valid_lft forever preferred_lft forever
8: vethdc1b46f@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span style="color:#666">1500</span> qdisc noqueue master docker0 
    link/ether 76:1b:92:6c:04:e5 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::741b:92ff:fe6c:4e5/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre></td></tr></table>
</div>
</div><p>可以看到容器内的网络环境与主机完全一致。</p>
<h4 id="container-网络模式">container 网络模式</h4>
<p>container 网络模式允许一个容器共享另一个容器的网络命名空间。当两个容器需要共享网络，但其他资源仍然需要隔离时就可以使用 container 网络模式，例如我们开发了一个 http 服务，但又想使用 nginx 的一些特性，让 nginx 代理外部的请求然后转发给自己的业务，这时我们使用 container 网络模式将自己开发的服务和 nginx 服务部署到同一个网络命名空间中。</p>
<p>下面我举例说明。首先我们使用以下命令启动一个 busybox1 容器：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run -d --name<span style="color:#666">=</span>busybox1 busybox sleep <span style="color:#666">3600</span>
</code></pre></td></tr></table>
</div>
</div><p>然后我们使用 <code>docker exec</code> 命令进入到 centos 容器中查看一下网络配置：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  ~ docker <span style="color:#a2f">exec</span> -it busybox1 sh                     
/ <span style="color:#080;font-style:italic"># ifconfig</span>
eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:03  
          inet addr:172.17.0.3  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:38 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:6519 <span style="color:#666">(</span>6.3 KiB<span style="color:#666">)</span>  TX bytes:0 <span style="color:#666">(</span>0.0 B<span style="color:#666">)</span>

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 <span style="color:#666">(</span>0.0 B<span style="color:#666">)</span>  TX bytes:0 <span style="color:#666">(</span>0.0 B<span style="color:#666">)</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到busybox1的ip地址为172.17.0.3</p>
<p>然后我们新打开一个命令行窗口，再启动一个 busybox2 容器，通过 container 网络模式连接到 busybox1 的网络，命令如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run -it --net<span style="color:#666">=</span>container:busybox1 --name<span style="color:#666">=</span>busybox2 busybox sh
/ #
</code></pre></td></tr></table>
</div>
</div><p>在 busybox2 容器内同样使用 ifconfig 命令查看一下容器内的网络配置：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/ <span style="color:#080;font-style:italic"># ifconfig</span>
eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:03  
          inet addr:172.17.0.3  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:46 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:7959 <span style="color:#666">(</span>7.7 KiB<span style="color:#666">)</span>  TX bytes:0 <span style="color:#666">(</span>0.0 B<span style="color:#666">)</span>

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 <span style="color:#666">(</span>0.0 B<span style="color:#666">)</span>  TX bytes:0 <span style="color:#666">(</span>0.0 B<span style="color:#666">)</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到busybox2容器内的网络IP也为172.17.0.3, 与busybox1的网络一致</p>
<p>以上就是 Libnetwork 常见的四种网络模式，它们的作用及业务场景帮你总结如下：</p>
<p><img src="https://s0.lgstatic.com/i/image/M00/59/ED/Ciqc1F9y8HGAaH1iAAClKDUq5FY736.png" alt=""></p>
<h3 id="小结-2">小结</h3>
<p>Libnetwork 的工作流程是完全围绕 CNM 的三个要素进行的，CNM 制定标准之初不仅仅是为了单台主机上的容器互通，更多的是为了定义跨主机之间的容器通信标准。但是后来由于 Kubernetes 逐渐成为了容器编排的标准，而 Kubernetes 最终选择了 CNI 作为容器网络的定义标准（具体原因可以参考<a href="https://kubernetes.io/blog/2016/01/why-kubernetes-doesnt-use-libnetwork/">这里</a>），很遗憾 CNM 最终没有成为跨主机容器通信的标准，但是 CNM 却为推动容器网络标准做出了重大贡献，且 Libnetwork 也是 Docker 的默认网络实现，提供了单独使用 Docker 容器时的多种网络接入功能。</p>
<h2 id="数据存储剖析docker卷与持久化数据存储的底层原理">数据存储：剖析Docker卷与持久化数据存储的底层原理</h2>
<h3 id="为什么容器需要持久化存储">为什么容器需要持久化存储</h3>
<p>容器按照业务类型，总体可以分为两类：</p>
<ul>
<li>
<p>无状态的（数据不需要被持久化）</p>
</li>
<li>
<p>有状态的（数据需要被持久化）</p>
</li>
</ul>
<p>显然，容器更擅长无状态应用。因为未持久化数据的容器根目录的生命周期与容器的生命周期一样，容器文件系统的本质是在镜像层上面创建的读写层，运行中的容器对任何文件的修改都存在于该读写层，当容器被删除时，容器中的读写层也会随之消失。</p>
<p>虽然容器希望所有的业务都尽量保持无状态，这样容器就可以开箱即用，并且可以任意调度，但实际业务总是有各种需要数据持久化的场景，比如 MySQL、Kafka 等有状态的业务。因此为了解决有状态业务的需求，Docker 提出了卷（Volume）的概念。</p>
<p>什么是卷？卷的本质是文件或者目录，它可以绕过默认的联合文件系统，直接以文件或目录的形式存在于宿主机上。卷的概念不仅解决了数据持久化的问题，还解决了容器间共享数据的问题。使用卷可以将容器内的目录或文件持久化，当容器重启后保证数据不丢失，例如我们可以使用卷将 MySQL 的目录持久化，实现容器重启数据库数据不丢失。</p>
<p>Docker 提供了卷（Volume）的功能，使用<code>docker volume</code>命令可以实现对卷的创建、查看和删除等操作。下面我们来详细了解一下这些命令。</p>
<h3 id="docker-卷的操作">Docker 卷的操作</h3>
<h4 id="创建数据卷">创建数据卷</h4>
<p>使用<code>docker volume create</code>命令可以创建一个数据卷。</p>
<p>我们使用以下命令创建一个名为 myvolume 的数据卷：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker volume create myvolume
</code></pre></td></tr></table>
</div>
</div><p>在这里要说明下，默认情况下 ，Docker 创建的数据卷为 local 模式，仅能提供本主机的容器访问。如果想要实现远程访问，需要借助网络存储来实现。Docker 的 local 存储模式并未提供配额管理，因此在生产环境中需要手动维护磁盘存储空间。</p>
<p>除了使用<code>docker volume create</code>的方式创建卷，我们还可以在 Docker 启动时使用 -v 的方式指定容器内需要被持久化的路径，Docker 会自动为我们创建卷，并且绑定到容器中，使用命令如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run -d --name<span style="color:#666">=</span>nginx-volume -v /usr/share/nginx/html nginx
</code></pre></td></tr></table>
</div>
</div><p>使用以上命令，我们启动了一个 nginx 容器，<code>-v</code>参数使得 Docker 自动生成一个卷并且绑定到容器的 /usr/share/nginx/html 目录中。<br>
我们可以使用<code>docker volume ls</code>命令来查看下主机上的卷：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker volume ls

DRIVER              VOLUME NAME
<span style="color:#a2f">local</span>               eaa8a223eb61a2091bf5cd5247c1b28ac287450a086d6eee9632d9d1b9f69171
</code></pre></td></tr></table>
</div>
</div><p>可以看到，Docker 自动为我们创建了一个名称为随机 ID 的卷。</p>
<h4 id="查看数据卷">查看数据卷</h4>
<p>已经创建的数据卷可以使用 docker volume ls 命令查看。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker volume ls

DRIVER              VOLUME NAME
<span style="color:#a2f">local</span>               myvolume
</code></pre></td></tr></table>
</div>
</div><p>通过输出可以看到 myvolume 卷已经创建成功。<br>
如果想要查看某个数据卷的详细信息，可以使用<code>docker volume inspect</code>命令。例如，我想查看 myvolume 的详细信息，命令如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker volume inspect myvolume

    <span style="color:#666">{</span>
<span style="color:#b44">&#34;CreatedAt&#34;</span>: <span style="color:#b44">&#34;2020-09-08T09:10:50Z&#34;</span>,
<span style="color:#b44">&#34;Driver&#34;</span>: <span style="color:#b44">&#34;local&#34;</span>,
<span style="color:#b44">&#34;Labels&#34;</span>: <span style="color:#666">{}</span>,
<span style="color:#b44">&#34;Mountpoint&#34;</span>: <span style="color:#b44">&#34;/var/lib/docker/volumes/myvolume/_data&#34;</span>,
<span style="color:#b44">&#34;Name&#34;</span>: <span style="color:#b44">&#34;myvolume&#34;</span>,
<span style="color:#b44">&#34;Options&#34;</span>: <span style="color:#666">{}</span>,
<span style="color:#b44">&#34;Scope&#34;</span>: <span style="color:#b44">&#34;local&#34;</span>
    <span style="color:#666">}</span>
<span style="color:#666">]</span>
</code></pre></td></tr></table>
</div>
</div><p>通过<code>docker volume inspect</code>命令可以看到卷的创建日期、命令、挂载路径信息。</p>
<h4 id="使用数据卷">使用数据卷</h4>
<p>使用<code>docker volume</code>创建的卷在容器启动时，添加 &ndash;mount 参数指定卷的名称即可使用。</p>
<p>这里我们使用上一步创建的卷来启动一个 nginx 容器，并将 /usr/share/nginx/html 目录与卷关联，命令如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker run -d --name<span style="color:#666">=</span>nginx --mount <span style="color:#b8860b">source</span><span style="color:#666">=</span>myvolume,target<span style="color:#666">=</span>/usr/share/nginx/html nginx
</code></pre></td></tr></table>
</div>
</div><p>使用 Docker 的卷可以实现指定目录的文件持久化，下面我们进入容器中并且修改 index.html 文件内容，命令如下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#a2f">exec</span> -it  nginx bash

#
root@719d3c32e211:/# cat <span style="color:#b44">&lt;&lt;EOF &gt;/usr/share/nginx/html/index.html
</span><span style="color:#b44">
</span><span style="color:#b44">&lt;!DOCTYPE html&gt;
</span><span style="color:#b44">&lt;html&gt;
</span><span style="color:#b44">&lt;head&gt;
</span><span style="color:#b44">&lt;title&gt;Hello, Docker Volume!&lt;/title&gt;
</span><span style="color:#b44">&lt;style&gt;
</span><span style="color:#b44">    body {
</span><span style="color:#b44">        width: 35em;
</span><span style="color:#b44">        margin: 0 auto;
</span><span style="color:#b44">        font-family: Tahoma, Verdana, Arial, sans-serif;
</span><span style="color:#b44">    }
</span><span style="color:#b44">&lt;/style&gt;
</span><span style="color:#b44">&lt;/head&gt;
</span><span style="color:#b44">&lt;body&gt;
</span><span style="color:#b44">&lt;h1&gt;Hello, Docker Volume!&lt;/h1&gt;
</span><span style="color:#b44">&lt;/body&gt;
</span><span style="color:#b44">&lt;/html&gt;
</span><span style="color:#b44">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>此时我们使用<code>docker rm</code>命令将运行中的 nginx 容器彻底删除。</p>
<p>旧的 nginx 容器删除后，我们再使用<code>docker run</code>命令启动一个新的容器，并且挂载 myvolume 卷，命令如下。</p>
<pre><code>$ docker run -d --name=nginx --mount source=myvolume,target=/usr/share/nginx/html nginx
</code></pre><p>新容器启动后，我们进入容器查看一下 index.html 文件内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker <span style="color:#a2f">exec</span> -it nginx bash

root@7ffac645f431:/# cat /usr/share/nginx/html/index.html

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Hello, Docker Volume!&lt;/title&gt;
&lt;style&gt;
body <span style="color:#666">{</span>
width: 35em;
margin: <span style="color:#666">0</span> auto;
font-family: Tahoma, Verdana, Arial, sans-serif;
    <span style="color:#666">}</span>
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Hello, Docker Volume!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></td></tr></table>
</div>
</div><p>可以看到，此时 index.html 文件内容依旧为我们之前写入的内容。可见，使用 Docker 卷后我们的数据并没有随着容器的删除而消失。</p>
<h4 id="删除数据卷">删除数据卷</h4>
<p>容器的删除并不会自动删除已经创建的数据卷，因此不再使用的数据卷需要我们手动删除，删除的命令为 docker volume rm 。例如，我们想要删除上面创建 myvolume 数据卷，可以使用以下命令：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker volume rm myvolume
</code></pre></td></tr></table>
</div>
</div><p>这里需要注意，正在被使用中的数据卷无法删除，如果你想要删除正在使用中的数据卷，需要先删除所有关联的容器。</p>
<p>有时候，两个容器之间会有共享数据的需求，很典型的一个场景就是容器内产生的日志需要一个专门的日志采集程序去采集日志内容，例如我需要使用 Filebeat (一种日志采集工具) 采集 nginx 容器内的日志，我就需要使用卷来共享一个日志目录，从而使得 Filebeat 和 nginx 容器都可以访问到这个目录，这时就需要用到容器之间共享数据卷的方式。</p>
<h4 id="容器与容器之间数据共享">容器与容器之间数据共享</h4>
<p>那如何实现容器与容器之间数据共享呢？下面我举例说明。</p>
<p>首先使用<code>docker volume create</code>命令创建一个共享日志的数据卷。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker volume create log-vol
</code></pre></td></tr></table>
</div>
</div><p>启动一个生产日志的容器（下面用 producer 窗口来表示）：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker run --mount <span style="color:#b8860b">source</span><span style="color:#666">=</span>log-vol,target<span style="color:#666">=</span>/tmp/log --name<span style="color:#666">=</span>log-producer -it busybox
</code></pre></td></tr></table>
</div>
</div><p>然后新打开一个命令行窗口，启动一个消费者容器（下面用 consumer 窗口来表示）：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker run -it --name consumer --volumes-from log-producer  busybox
</code></pre></td></tr></table>
</div>
</div><p>使用<code>volumes-from</code>参数可以在启动新的容器时来挂载已经存在的容器的卷，<code>volumes-from</code>参数后面跟已经启动的容器名称。<br>
下面我们切换到 producer 窗口，使用以下命令创建一个 mylog.log 文件并写入 &ldquo;Hello，My log.&rdquo; 的内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">/ <span style="color:#080;font-style:italic"># cat &lt;&lt;EOF &gt;/tmp/log/mylog.log</span>

Hello, My log.
EOF
</code></pre></td></tr></table>
</div>
</div><p>然后我们切换到 consumer 窗口，查看一下相关内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">/ <span style="color:#080;font-style:italic"># cat /tmp/log/mylog.log</span>


Hello, My log.

</code></pre></td></tr></table>
</div>
</div><p>可以看到我们从 producer 容器写入的文件内容会自动出现在 consumer 容器中，证明我们成功实现了两个容器间的数据共享。</p>
<p>总结一下，我们首先使用 docker volume create 命令创建了 log-vol 卷来作为共享目录，log-producer 容器向该卷写入数据，consumer 容器从该卷读取数据。这就像主机上的两个进程，一个向主机目录写数据，一个从主机目录读数据，利用主机的目录，实现了容器之间的数据共享。</p>
<h4 id="主机与容器之间数据共享">主机与容器之间数据共享</h4>
<p>Docker 卷的目录默认在 /var/lib/docker 下，当我们想把主机的其他目录映射到容器内时，就需要用到主机与容器之间数据共享的方式了，例如我想把 MySQL 容器中的 /var/lib/mysql 目录映射到主机的 /var/lib/mysql 目录中，我们就可以使用主机与容器之间数据共享的方式来实现。</p>
<p>要实现主机与容器之间数据共享，其实很简单，只需要我们在启动容器的时候添加<code>-v</code>参数即可, 使用格式为：<code>-v HOST_PATH:CONTIANAER_PATH</code>。</p>
<p>例如，我想挂载主机的 /data 目录到容器中的 /usr/local/data 中，可以使用以下命令来启动容器：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run -v /data:/usr/local/data -it busybox
</code></pre></td></tr></table>
</div>
</div><p>容器启动后，便可以在容器内的 /usr/local/data 访问到主机 /data 目录的内容了，并且容器重启后，/data 目录下的数据也不会丢失。</p>
<p>以上就是 Docker 卷的操作，关键命令我帮你总结如下：</p>
<p><img src="https://s0.lgstatic.com/i/image/M00/5C/50/Ciqc1F-BW1SAQEkaAACOwJuMTHI950.png" alt=""></p>
<p>那你了解完卷的相关操作后，你有没有想过 Docker 的卷是怎么实现的呢？接下来我们就看看卷的实现原理。</p>
<h3 id="docker-卷的实现原理">Docker 卷的实现原理</h3>
<p>在了解 Docker 卷的原理之前，我们先来回顾一下镜像和容器的文件系统原理。</p>
<blockquote>
<p><strong>镜像和容器的文件系统原理：</strong> 镜像是由多层文件系统组成的，当我们想要启动一个容器时，Docker 会在镜像上层创建一个可读写层，容器中的文件都工作在这个读写层中，当容器删除时，与容器相关的工作文件将全部丢失。</p>
</blockquote>
<p>Docker 容器的文件系统不是一个真正的文件系统，而是通过联合文件系统实现的一个伪文件系统，而 Docker 卷则是直接利用主机的某个文件或者目录，它可以绕过联合文件系统，直接挂载主机上的文件或目录到容器中，这就是它的工作原理。</p>
<p>下面，我们通过一个实例来说明卷的工作原理。首先，我们创建一个名称为 volume-data 的卷：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker volume create volume-data
</code></pre></td></tr></table>
</div>
</div><p>我们使用 ls 命令查看一下 /var/lib/docker/volumes 目录下的内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sudo ls -l /var/lib/docker/volumes

drwxr-xr-x. <span style="color:#666">3</span> root root    <span style="color:#666">19</span> Sep  <span style="color:#666">8</span> 10:59 volume-data
</code></pre></td></tr></table>
</div>
</div><p>然后再看下 volume-data 目录下有什么内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sudo ls -l /var/lib/docker/volumes/volume-data
total <span style="color:#666">0</span>
drwxr-xr-x. <span style="color:#666">2</span> root root <span style="color:#666">6</span> Sep  <span style="color:#666">8</span> 10:59 _data
</code></pre></td></tr></table>
</div>
</div><p>可以看到我们创建的卷出现在了 /var/lib/docker/volumes 目录下，并且 volume-data 目录下还创建了一个 _data 目录。</p>
<p>实际上，在我们创建 Docker 卷时，Docker 会把卷的数据全部放在 /var/lib/docker/volumes 目录下，并且在每个对应的卷的目录下创建一个 _data 目录，然后把 _data 目录绑定到容器中。因此我们在容器中挂载卷的目录下操作文件，实际上是在操作主机上的 _data 目录。为了证实我的说法，我们来实际演示下。</p>
<p>首先，我们启动一个容器，并且绑定 volume-data 卷到容器内的 /data 目录下：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$  docker run -it --mount <span style="color:#b8860b">source</span><span style="color:#666">=</span>volume-data,target<span style="color:#666">=</span>/data busybox

/ #
</code></pre></td></tr></table>
</div>
</div><p>我们进入到容器的 /data 目录，创建一个 data.log 文件:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">/ <span style="color:#080;font-style:italic"># cd data/</span>


/data <span style="color:#080;font-style:italic"># touch data.log</span>

</code></pre></td></tr></table>
</div>
</div><p>然后我们新打开一个命令行窗口，查看一下主机上的文件内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$  sudo ls -l /var/lib/docker/volumes/volume-data/_data


total <span style="color:#666">0</span>


-rw-r--r--. <span style="color:#666">1</span> root root <span style="color:#666">0</span> Sep  <span style="color:#666">8</span> 11:15 data.log

</code></pre></td></tr></table>
</div>
</div><p>可以看到主机上的 _data 目录下也出现了 data.log 文件。这说明，在容器内操作卷挂载的目录就是直接操作主机上的 _data 目录，符合我上面的说法。</p>
<p>综上，<strong>Docker 卷的实现原理是在主机的 /var/lib/docker/volumes 目录下，根据卷的名称创建相应的目录，然后在每个卷的目录下创建 _data 目录，在容器启动时如果使用 &ndash;mount 参数，Docker 会把主机上的目录直接映射到容器的指定目录下，实现数据持久化。</strong></p>
<h3 id="结语">结语</h3>
<p>到此，相信你已经了解了 Docker 使用卷做持久化存储的必要性，也了解 Docker 卷的常用操作，并且对卷的实现原理也有了较清晰的认识。</p>
<p>那么，你知道 Docker 如何使用卷来挂载 NFS 类型的持久化存储到容器内吗？思考后，把你的想法写在留言区。</p>
<p>下一课时，我将讲解 Docker 文件存储驱动 AUFS 的系统原理及生产环境的最佳配置。</p>
<h2 id="文件存储驱动aufs">文件存储驱动：AUFS</h2>
<h3 id="什么是联合文件系统">什么是联合文件系统</h3>
<p>联合文件系统（Union File System，Unionfs）是一种分层的轻量级文件系统，它可以把多个目录内容联合挂载到同一目录下，从而形成一个单一的文件系统，这种特性可以让使用者像是使用一个目录一样使用联合文件系统。</p>
<p>那联合文件系统对于 Docker 是一个怎样的存在呢？它可以说是 Docker 镜像和容器的基础，因为<strong>它可以使 Docker 可以把镜像做成分层的结构，从而使得镜像的每一层可以被共享</strong>。例如两个业务镜像都是基于 CentOS 7 镜像构建的，那么这两个业务镜像在物理机上只需要存储一次 CentOS 7 这个基础镜像即可，从而节省大量存储空间。</p>
<p>说到这儿，你有没有发现，联合文件系统只是一个概念，真正实现联合文件系统才是关键，那如何实现呢？其实实现方案有很多，Docker 中最常用的联合文件系统有三种：AUFS、Devicemapper 和 OverlayFS。</p>
<p>今天我主要讲解 Docker 中最常用的联合文件系统里的 AUFS，为什么呢？因为 AUFS 是 Docker 最早使用的文件系统驱动，多用于 Ubuntu 和 Debian 系统中。在 Docker 早期，OverlayFS 和 Devicemapper 相对不够成熟，AUFS 是最早也是最稳定的文件系统驱动。 Devicemapper 和 OverlayFS 联合文件系统，我将在第 15 和 16 课时为你详细剖析 。</p>
<p>接下来，我们就看看如何配置 Docker 的 AUFS 模式。</p>
<h3 id="如何配置-docker-的-aufs-模式">如何配置 Docker 的 AUFS 模式</h3>
<p>AUFS 目前并未被合并到 Linux 内核主线，因此只有 Ubuntu 和 Debian 等少数操作系统支持 AUFS。你可以使用以下命令查看你的系统是否支持 AUFS：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ grep aufs /proc/filesystems

nodev   aufs
</code></pre></td></tr></table>
</div>
</div><p>执行以上命令后，如果输出结果包含<code>aufs</code>，则代表当前操作系统支持 AUFS。AUFS 推荐在 Ubuntu 或 Debian 操作系统下使用，如果你想要在 CentOS 等操作系统下使用 AUFS，需要单独安装 AUFS 模块（生产环境不推荐在 CentOS 下使用 AUFS，如果你想在 CentOS 下安装 AUFS 用于研究和测试，可以参考这个<a href="https://github.com/bnied/kernel-ml-aufs">链接</a>），安装完成后使用上述命令输出结果中有<code>aufs</code>即可。</p>
<p>当确认完操作系统支持 AUFS 后，你就可以配置 Docker 的启动参数了。</p>
<p>先在 /etc/docker 下新建 daemon.json 文件，并写入以下内容：</p>
<pre><code>{
&quot;storage-driver&quot;: &quot;aufs&quot;
}
</code></pre><p>然后使用以下命令重启 Docker：</p>
<pre><code>$ sudo systemctl restart docker
</code></pre><p>Docker 重启以后使用<code>docker info</code>命令即可查看配置是否生效：</p>
<pre><code>$ sudo docker info

Client:
 Debug Mode: false

Server:
 Containers: 0
  Running: 0
  Paused: 0
  Stopped: 0
 Images: 1
 Server Version: 19.03.12
 Storage Driver: aufs
  Root Dir: /var/lib/docker/aufs
  Backing Filesystem: extfs
  Dirs: 1
  Dirperm1 Supported: true
</code></pre><p>可以看到 Storage Driver 已经变为 aufs，证明配置已经生效，配置生效后就可以使用 AUFS 为 Docker 提供联合文件系统了。</p>
<p>配置好 Docker 的 AUFS 联合文件系统后，你一定很好奇 AUFS 到底是如何工作的呢？下面我带你详细学习一下 AUFS 的工作原理。</p>
<h3 id="aufs-工作原理">AUFS 工作原理</h3>
<h4 id="aufs-是如何存储文件的">AUFS 是如何存储文件的？</h4>
<p>AUFS 是联合文件系统，意味着它在主机上使用多层目录存储，<strong>每一个目录在 AUFS 中都叫作分支，而在 Docker 中则称之为层（layer），但最终呈现给用户的则是一个普通单层的文件系统，我们把多层以单一层的方式呈现出来的过程叫作联合挂载。</strong></p>
<p><img src="https://s0.lgstatic.com/i/image/M00/5E/82/CgqCHl-GwcCAOu4aAABzKSlpRlI180.png" alt=""></p>
<p>如图 1 所示，每一个镜像层和容器层都是 /var/lib/docker 下的一个子目录，镜像层和容器层都在 aufs/diff 目录下，每一层的目录名称是镜像或容器的 ID 值，联合挂载点在 aufs/mnt 目录下，mnt 目录是真正的容器工作目录。</p>
<p>下面我们针对 aufs 文件夹下的各目录结构，在创建容器前后的变化做详细讲述。</p>
<p>当一个镜像未生成容器时，AUFS 的存储结构如下。</p>
<ul>
<li>
<p>diff 文件夹：存储镜像内容，每一层都存储在以镜像层 ID 命名的子文件夹中。</p>
</li>
<li>
<p>layers 文件夹：存储镜像层关系的元数据，在 diif 文件夹下的每个镜像层在这里都会有一个文件，文件的内容为该层镜像的父级镜像的 ID。</p>
</li>
<li>
<p>mnt 文件夹：联合挂载点目录，未生成容器时，该目录为空。</p>
</li>
</ul>
<p>当一个镜像已经生成容器时，AUFS 存储结构会发生如下变化。</p>
<ul>
<li>
<p>diff 文件夹：当容器运行时，会在 diff 目录下生成容器层。</p>
</li>
<li>
<p>layers 文件夹：增加容器层相关的元数据。</p>
</li>
<li>
<p>mnt 文件夹：容器的联合挂载点，这和容器中看到的文件内容一致。</p>
</li>
</ul>
<p>以上便是 AUFS 的工作原理，那你知道容器的在工作过程中是如何使用 AUFS 的吗？</p>
<h4 id="aufs-是如何工作的">AUFS 是如何工作的？</h4>
<p>AUFS 的工作过程中对文件的操作分为读取文件和修改文件。下面我们分别来看下 AUFS 对于不同的文件操作是如何工作的。</p>
<h5 id="1-读取文件">1. 读取文件</h5>
<p>当我们在容器中读取文件时，可能会有以下场景。</p>
<ul>
<li>
<p>文件在容器层中存在时：当文件存在于容器层时，直接从容器层读取。</p>
</li>
<li>
<p>当文件在容器层中不存在时：当容器运行时需要读取某个文件，如果容器层中不存在时，则从镜像层查找该文件，然后读取文件内容。</p>
</li>
<li>
<p>文件既存在于镜像层，又存在于容器层：当我们读取的文件既存在于镜像层，又存在于容器层时，将会从容器层读取该文件。</p>
</li>
</ul>
<h5 id="2-修改文件或目录">2. 修改文件或目录</h5>
<p>AUFS 对文件的修改采用的是写时复制的工作机制，这种工作机制可以最大程度节省存储空间。</p>
<p>具体的文件操作机制如下。</p>
<ul>
<li>第一次修改文件：当我们第一次在容器中修改某个文件时，AUFS 会触发写时复制操作，AUFS 首先从镜像层复制文件到容器层，然后再执行对应的修改操作。</li>
</ul>
<blockquote>
<p>AUFS 写时复制的操作将会复制整个文件，如果文件过大，将会大大降低文件系统的性能，因此当我们有大量文件需要被修改时，AUFS 可能会出现明显的延迟。好在，写时复制操作只在第一次修改文件时触发，对日常使用没有太大影响。</p>
</blockquote>
<ul>
<li>删除文件或目录：当文件或目录被删除时，AUFS 并不会真正从镜像中删除它，因为镜像层是只读的，AUFS 会创建一个特殊的文件或文件夹，这种特殊的文件或文件夹会阻止容器的访问。</li>
</ul>
<h2 id="文件存储驱动devicemapper">文件存储驱动：Devicemapper</h2>
<h3 id="什么是-devicemapper-">什么是 Devicemapper ？</h3>
<p>Devicemapper 是 Linux 内核提供的框架，从 Linux 内核 2.6.9 版本开始引入，Devicemapper 与 AUFS 不同，AUFS 是一种文件系统，而 <strong>Devicemapper 是一种映射块设备的技术框架。</strong></p>
<p>Devicemapper 提供了一种<strong>将物理块设备映射到虚拟块设备的机制</strong>，目前 Linux 下比较流行的 LVM （Logical Volume Manager 是 Linux 下对磁盘分区进行管理的一种机制）和软件磁盘阵列（将多个较小的磁盘整合成为一个较大的磁盘设备用于扩大磁盘存储和提供数据可用性）都是基于 Devicemapper 机制实现的。</p>
<p>那么 Devicemapper 究竟是如何实现的呢？下面我们首先来了解一下它的关键技术。</p>
<h3 id="devicemapper-的关键技术">Devicemapper 的关键技术</h3>
<p>Devicemapper 将主要的工作部分分为<strong>用户空间</strong>和<strong>内核空间</strong>。</p>
<ul>
<li>
<p>用户空间负责配置具体的<strong>设备映射策略</strong>与相关的<strong>内核空间控制逻辑</strong>，例如逻辑设备 dm-a 如何与物理设备 sda 相关联，怎么建立逻辑设备和物理设备的映射关系等。</p>
</li>
<li>
<p>内核空间则负责<strong>用户空间配置的关联关系实现</strong>，例如当 IO 请求到达虚拟设备 dm-a 时，内核空间负责接管 IO 请求，然后处理和过滤这些 IO 请求并转发到具体的物理设备 sda 上。</p>
</li>
</ul>
<p>这个架构类似于 C/S （客户端 / 服务端）架构的工作模式，客户端负责具体的规则定义和配置下发，服务端根据客户端配置的规则来执行具体的处理任务。</p>
<p>Devicemapper 的工作机制主要围绕三个核心概念。</p>
<ul>
<li>
<p>映射设备（mapped device）：即对外提供的逻辑设备，它是由 Devicemapper 模拟的一个虚拟设备，并不是真正存在于宿主机上的物理设备。</p>
</li>
<li>
<p>目标设备（target device）：目标设备是映射设备对应的物理设备或者物理设备的某一个逻辑分段，是真正存在于物理机上的设备。</p>
</li>
<li>
<p>映射表（map table）：映射表记录了映射设备到目标设备的映射关系，它记录了映射设备在目标设备的起始地址、范围和目标设备的类型等变量。</p>
</li>
</ul>
<p><img src="https://s0.lgstatic.com/i/image/M00/5E/87/CgqCHl-GyFOAG6TPAACE_8cMjoQ585.png" alt=""></p>
<p>图 1 Devicemapper 核心概念关系图</p>
<p>Devicemapper 三个核心概念之间的关系如图 1，<strong>映射设备通过映射表关联到具体的物理目标设备。事实上，映射设备不仅可以通过映射表关联到物理目标设备，也可以关联到虚拟目标设备，然后虚拟目标设备再通过映射表关联到物理目标设备。</strong></p>
<p>Devicemapper 在内核中通过很多模块化的映射驱动（target driver）插件实现了对真正 IO 请求的拦截、过滤和转发工作，比如 Raid、软件加密、瘦供给（Thin Provisioning）等。其中瘦供给模块是 Docker 使用 Devicemapper 技术框架中非常重要的模块，下面我们来详细了解下瘦供给（Thin Provisioning）。</p>
<h4 id="瘦供给thin-provisioning">瘦供给（Thin Provisioning）</h4>
<p>瘦供给的意思是<strong>动态分配</strong>，这跟传统的固定分配不一样。传统的固定分配是无论我们用多少都一次性分配一个较大的空间，这样可能导致空间浪费。而瘦供给<strong>是我们需要多少磁盘空间，存储驱动就帮我们分配多少磁盘空间</strong>。</p>
<p>这种分配机制就好比我们一群人围着一个大锅吃饭，负责分配食物的人每次都给你一点分量，当你感觉食物不够时再去申请食物，而当你吃饱了就不需要再去申请食物了，从而避免了食物的浪费，节约的食物可以分配给更多需要的人。</p>
<p>那么，你知道 Docker 是如何使用瘦供给来做到像 AUFS 那样分层存储文件的吗？答案就是： Docker 使用了瘦供给的快照（snapshot）技术。</p>
<p>什么是快照（snapshot）技术？这是全球网络存储工业协会 SNIA（StorageNetworking Industry Association）对快照（Snapshot）的定义：</p>
<blockquote>
<p>关于指定数据集合的一个完全可用拷贝，该拷贝包括相应数据在某个时间点（拷贝开始的时间点）的映像。快照可以是其所表示的数据的一个副本，也可以是数据的一个复制品。</p>
</blockquote>
<p>简单来说，<strong>快照是数据在某一个时间点的存储状态。快照的主要作用是对数据进行备份，当存储设备发生故障时，可以使用已经备份的快照将数据恢复到某一个时间点，而 Docker 中的数据分层存储也是基于快照实现的。</strong></p>
<p>以上便是实现 Devicemapper 的关键技术，那 Docker 究竟是如何使用 Devicemapper 实现存储数据和镜像分层共享的呢？</p>
<h3 id="devicemapper-是如何数据存储的">Devicemapper 是如何数据存储的？</h3>
<p>当 Docker 使用 Devicemapper 作为文件存储驱动时，<strong>Docker 将镜像和容器的文件存储在瘦供给池（thinpool）中，并将这些内容挂载在 /var/lib/docker/devicemapper/ 目录下。</strong></p>
<p>这些目录储存 Docker 的容器和镜像相关数据，目录的数据内容和功能说明如下。</p>
<ul>
<li>
<p>devicemapper 目录（/var/lib/docker/devicemapper/devicemapper/）：存储镜像和容器实际内容，该目录由一个或多个块设备构成。</p>
</li>
<li>
<p>metadata 目录（/var/lib/docker/devicemapper/metadata/）： 包含 Devicemapper 本身配置的元数据信息, 以 json 的形式配置，这些元数据记录了镜像层和容器层之间的关联信息。</p>
</li>
<li>
<p>mnt 目录（ /var/lib/docker/devicemapper/mnt/）：是容器的联合挂载点目录，未生成容器时，该目录为空，而容器存在时，该目录下的内容跟容器中一致。</p>
</li>
</ul>
<h3 id="devicemapper-如何实现镜像分层与共享">Devicemapper 如何实现镜像分层与共享？</h3>
<p>Devicemapper 使用专用的块设备实现镜像的存储，并且像 AUFS 一样使用了写时复制的技术来保障最大程度节省存储空间，所以 Devicemapper 的镜像分层也是依赖快照来是实现的。</p>
<p>Devicemapper 的每一镜像层都是其下一层的快照，最底层的镜像层是我们的瘦供给池，通过这种方式实现镜像分层有以下优点。</p>
<ul>
<li>
<p>相同的镜像层，仅在磁盘上存储一次。例如，我有 10 个运行中的 busybox 容器，底层都使用了 busybox 镜像，那么 busybox 镜像只需要在磁盘上存储一次即可。</p>
</li>
<li>
<p>快照是写时复制策略的实现，也就是说，当我们需要对文件进行修改时，文件才会被复制到读写层。</p>
</li>
<li>
<p>相比对文件系统加锁的机制，Devicemapper 工作在块级别，因此可以实现同时修改和读写层中的多个块设备，比文件系统效率更高。</p>
</li>
</ul>
<p>当我们需要读取数据时，如果数据存在底层快照中，则向底层快照查询数据并读取。当我们需要写数据时，则向瘦供给池动态申请存储空间生成读写层，然后把数据复制到读写层进行修改。Devicemapper 默认每次申请的大小是 64K 或者 64K 的倍数，因此每次新生成的读写层的大小都是 64K 或者 64K 的倍数。</p>
<p>以下是一个运行中的 Ubuntu 容器示意图。</p>
<p><img src="https://s0.lgstatic.com/i/image/M00/5E/87/CgqCHl-GyHeAX_zKAABoNW4U26c205.png" alt=""></p>
<p>图 2 Devicemapper 存储模型</p>
<p>这个 Ubuntu 镜像一共有四层，<strong>每一层镜像都是下一层的快照</strong>，<strong>镜像的最底层是基础设备的快照</strong>。当容器运行时，容器是基于镜像的快照。综上，Devicemapper 实现镜像分层的根本原理就是快照。</p>
<p>接下来，我们看下如何配置 Docker 的 Devicemapper 模式。</p>
<h2 id="文件存储驱动overlayfs">文件存储驱动：OverlayFS</h2>
<p>OverlayFS 的发展分为两个阶段。2014 年，OverlayFS 第一个版本被合并到 Linux 内核 3.18 版本中，此时的 OverlayFS 在 Docker 中被称为<code>overlay</code>文件驱动。由于第一版的<code>overlay</code>文件系统存在很多弊端（例如运行一段时间后 Docker 会报 &ldquo;too many links problem&rdquo; 的错误）， Linux 内核在 4.0 版本对<code>overlay</code>做了很多必要的改进，此时的 OverlayFS 被称之为<code>overlay2</code>。</p>
<p>因此，在 Docker 中 OverlayFS 文件驱动被分为了两种，一种是早期的<code>overlay</code>，不推荐在生产环境中使用，另一种是更新和更稳定的<code>overlay2</code>，推荐在生产环境中使用。下面的内容我们主要围绕<code>overlay2</code>展开。</p>
<h3 id="overlay2-工作原理">overlay2 工作原理</h3>
<h4 id="overlay2-是如何存储文件的">overlay2 是如何存储文件的？</h4>
<p>overlay2 和 AUFS 类似，它将所有目录称之为层（layer），overlay2 的目录是镜像和容器分层的基础，而把这些层统一展现到同一的目录下的过程称为联合挂载（union mount）。overlay2 把目录的下一层叫作<code>lowerdir</code>，上一层叫作<code>upperdir</code>，联合挂载后的结果叫作<code>merged</code>。</p>
<blockquote>
<p>overlay2 文件系统最多支持 128 个层数叠加，也就是说你的 Dockerfile 最多只能写 128 行，不过这在日常使用中足够了。</p>
</blockquote>
<p>下面我们通过拉取一个 Ubuntu 操作系统的镜像来看下 overlay2 是如何存放镜像文件的。</p>
<p>首先，我们通过以下命令拉取 Ubuntu 镜像：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker pull ubuntu:16.04
16.04: Pulling from library/ubuntu
8e097b52bfb8: Pull <span style="color:#a2f">complete</span>
a613a9b4553c: Pull <span style="color:#a2f">complete</span>
acc000f01536: Pull <span style="color:#a2f">complete</span>
73eef93b7466: Pull <span style="color:#a2f">complete</span>
Digest: sha256:3dd44f7ca10f07f86add9d0dc611998a1641f501833692a2651c96defe8db940
Status: Downloaded newer image <span style="color:#a2f;font-weight:bold">for</span> ubuntu:16.04
docker.io/library/ubuntu:16.04
</code></pre></td></tr></table>
</div>
</div><p>可以看到镜像一共被分为四层拉取，拉取完镜像后我们查看一下 overlay2 的目录：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ls -l /var/lib/docker/overlay2/

total <span style="color:#666">0</span>
drwx------. <span style="color:#666">3</span> root root      <span style="color:#666">47</span> Sep <span style="color:#666">13</span> 08:16 01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a
drwx------. <span style="color:#666">4</span> root root      <span style="color:#666">55</span> Sep <span style="color:#666">13</span> 08:16 0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb
drwx------. <span style="color:#666">4</span> root root      <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:16 94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f
drwx------. <span style="color:#666">4</span> root root      <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:16 9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396
brw-------. <span style="color:#666">1</span> root root 253, <span style="color:#666">17</span> Sep <span style="color:#666">13</span> 08:14 backingFsBlockDev
drwx------. <span style="color:#666">2</span> root root     <span style="color:#666">142</span> Sep <span style="color:#666">13</span> 08:16 l
</code></pre></td></tr></table>
</div>
</div><p>可以看到 overlay2 目录下出现了四个镜像层目录和一个<code>l</code>目录，我们首先来查看一下<code>l</code>目录的内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ls -l /var/lib/docker/overlay2/l

total <span style="color:#666">0</span>
lrwxrwxrwx. <span style="color:#666">1</span> root root <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:16 FWGSYEA56RNMS53EUCKEQIKVLQ -&gt; ../9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396/diff
lrwxrwxrwx. <span style="color:#666">1</span> root root <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:16 RNN2FM3YISKADNAZFRONVNWTIS -&gt; ../0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/diff
lrwxrwxrwx. <span style="color:#666">1</span> root root <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:16 SHAQ5GYA3UZLJJVEGXEZM34KEE -&gt; ../01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a/diff
lrwxrwxrwx. <span style="color:#666">1</span> root root <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:16 VQSNH735KNX4YK2TCMBAJRFTGT -&gt; ../94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f/diff
</code></pre></td></tr></table>
</div>
</div><p>可以看到<code>l</code>目录是一堆软连接，把一些较短的随机串软连到镜像层的 diff 文件夹下，这样做是为了避免达到<code>mount</code>命令参数的长度限制。<br>
下面我们查看任意一个镜像层下的文件内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ls -l /var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/

total <span style="color:#666">8</span>
drwxr-xr-x. <span style="color:#666">3</span> root root <span style="color:#666">17</span> Sep <span style="color:#666">13</span> 08:16 diff
-rw-r--r--. <span style="color:#666">1</span> root root <span style="color:#666">26</span> Sep <span style="color:#666">13</span> 08:16 link
-rw-r--r--. <span style="color:#666">1</span> root root <span style="color:#666">86</span> Sep <span style="color:#666">13</span> 08:16 lower
drwx------. <span style="color:#666">2</span> root root  <span style="color:#666">6</span> Sep <span style="color:#666">13</span> 08:16 work
</code></pre></td></tr></table>
</div>
</div><p><strong>镜像层的 link 文件内容为该镜像层的短 ID，diff 文件夹为该镜像层的改动内容，lower 文件为该层的所有父层镜像的短 ID。</strong><br>
我们可以通过<code>docker image inspect</code>命令来查看某个镜像的层级关系，例如我想查看刚刚下载的 Ubuntu 镜像之间的层级关系，可以使用以下命令：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker image inspect ubuntu:16.04

...省略部分输出
<span style="color:#b44">&#34;GraphDriver&#34;</span>: <span style="color:#666">{</span>
<span style="color:#b44">&#34;Data&#34;</span>: <span style="color:#666">{</span>
<span style="color:#b44">&#34;LowerDir&#34;</span>: <span style="color:#b44">&#34;/var/lib/docker/overlay2/9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396/diff:/var/lib/docker/overlay2/94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f/diff:/var/lib/docker/overlay2/01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a/diff&#34;</span>,
<span style="color:#b44">&#34;MergedDir&#34;</span>: <span style="color:#b44">&#34;/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/merged&#34;</span>,
<span style="color:#b44">&#34;UpperDir&#34;</span>: <span style="color:#b44">&#34;/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/diff&#34;</span>,
<span style="color:#b44">&#34;WorkDir&#34;</span>: <span style="color:#b44">&#34;/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/work&#34;</span>
            <span style="color:#666">}</span>,
<span style="color:#b44">&#34;Name&#34;</span>: <span style="color:#b44">&#34;overlay2&#34;</span>
        <span style="color:#666">}</span>,
...省略部分输出
</code></pre></td></tr></table>
</div>
</div><p>其中 MergedDir 代表当前镜像层在 overlay2 存储下的目录，LowerDir 代表当前镜像的父层关系，使用冒号分隔，冒号最后代表该镜像的最底层。</p>
<p>下面我们将镜像运行起来成为容器：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker run --name<span style="color:#666">=</span>ubuntu -d ubuntu:16.04 sleep <span style="color:#666">3600</span>
</code></pre></td></tr></table>
</div>
</div><p>我们使用<code>docker inspect</code>命令来查看一下容器的工作目录：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ docker inspect ubuntu

...省略部分输出
<span style="color:#b44">&#34;GraphDriver&#34;</span>: <span style="color:#666">{</span>
<span style="color:#b44">&#34;Data&#34;</span>: <span style="color:#666">{</span>
<span style="color:#b44">&#34;LowerDir&#34;</span>: <span style="color:#b44">&#34;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2-init/diff:/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/diff:/var/lib/docker/overlay2/9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396/diff:/var/lib/docker/overlay2/94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f/diff:/var/lib/docker/overlay2/01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a/diff&#34;</span>,
<span style="color:#b44">&#34;MergedDir&#34;</span>: <span style="color:#b44">&#34;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2/merged&#34;</span>,
<span style="color:#b44">&#34;UpperDir&#34;</span>: <span style="color:#b44">&#34;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2/diff&#34;</span>,
<span style="color:#b44">&#34;WorkDir&#34;</span>: <span style="color:#b44">&#34;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2/work&#34;</span>
            <span style="color:#666">}</span>,
<span style="color:#b44">&#34;Name&#34;</span>: <span style="color:#b44">&#34;overlay2&#34;</span>
        <span style="color:#666">}</span>,
...省略部分输出
</code></pre></td></tr></table>
</div>
</div><p><strong>MergedDir 后面的内容即为容器层的工作目录，LowerDir 为容器所依赖的镜像层目录。</strong> 然后我们查看下 overlay2 目录下的内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ls -l /var/lib/docker/overlay2/

total <span style="color:#666">0</span>
drwx------. <span style="color:#666">3</span> root root      <span style="color:#666">47</span> Sep <span style="color:#666">13</span> 08:16 01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a
drwx------. <span style="color:#666">4</span> root root      <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:47 0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb
drwx------. <span style="color:#666">5</span> root root      <span style="color:#666">69</span> Sep <span style="color:#666">13</span> 08:47 4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2
drwx------. <span style="color:#666">4</span> root root      <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:47 4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2-init
drwx------. <span style="color:#666">4</span> root root      <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:16 94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f
drwx------. <span style="color:#666">4</span> root root      <span style="color:#666">72</span> Sep <span style="color:#666">13</span> 08:16 9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396
brw-------. <span style="color:#666">1</span> root root 253, <span style="color:#666">17</span> Sep <span style="color:#666">13</span> 08:14 backingFsBlockDev
drwx------. <span style="color:#666">2</span> root root     <span style="color:#666">210</span> Sep <span style="color:#666">13</span> 08:47 l
</code></pre></td></tr></table>
</div>
</div><p>可以看到 overlay2 目录下增加了容器层相关的目录，我们再来查看一下容器层下的内容：</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sudo ls -l /var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2

total <span style="color:#666">8</span>
drwxr-xr-x. <span style="color:#666">2</span> root root   <span style="color:#666">6</span> Sep <span style="color:#666">13</span> 08:47 diff
-rw-r--r--. <span style="color:#666">1</span> root root  <span style="color:#666">26</span> Sep <span style="color:#666">13</span> 08:47 link
-rw-r--r--. <span style="color:#666">1</span> root root <span style="color:#666">144</span> Sep <span style="color:#666">13</span> 08:47 lower
drwxr-xr-x. <span style="color:#666">1</span> root root   <span style="color:#666">6</span> Sep <span style="color:#666">13</span> 08:47 merged
drwx------. <span style="color:#666">3</span> root root  <span style="color:#666">18</span> Sep <span style="color:#666">13</span> 08:47 work
</code></pre></td></tr></table>
</div>
</div><p>link 和 lower 文件与镜像层的功能一致，****link 文件内容为该容器层的短 ID，lower 文件为该层的所有父层镜像的短 ID 。<strong>diff 目录为容器的读写层，容器内修改的文件都会在 diff 中出现，merged 目录为分层文件联合挂载后的结果，也是容器内的工作目录。</strong></p>
<p>总体来说，overlay2 是这样储存文件的：<code>overlay2</code>将镜像层和容器层都放在单独的目录，并且有唯一 ID，每一层仅存储发生变化的文件，最终使用联合挂载技术将容器层和镜像层的所有文件统一挂载到容器中，使得容器中看到完整的系统文件。</p>
<h4 id="overlay2-如何读取修改文件">overlay2 如何读取、修改文件？</h4>
<p>overlay2 的工作过程中对文件的操作分为读取文件和修改文件。</p>
<p><strong>读取文件</strong></p>
<p>容器内进程读取文件分为以下三种情况。</p>
<ul>
<li>
<p>文件在容器层中存在：当文件存在于容器层并且不存在于镜像层时，直接从容器层读取文件；</p>
</li>
<li>
<p>当文件在容器层中不存在：当容器中的进程需要读取某个文件时，如果容器层中不存在该文件，则从镜像层查找该文件，然后读取文件内容；</p>
</li>
<li>
<p>文件既存在于镜像层，又存在于容器层：当我们读取的文件既存在于镜像层，又存在于容器层时，将会从容器层读取该文件。</p>
</li>
</ul>
<p><strong>修改文件或目录</strong></p>
<p>overlay2 对文件的修改采用的是写时复制的工作机制，这种工作机制可以最大程度节省存储空间。具体的文件操作机制如下。</p>
<ul>
<li>第一次修改文件：当我们第一次在容器中修改某个文件时，overlay2 会触发写时复制操作，overlay2 首先从镜像层复制文件到容器层，然后在容器层执行对应的文件修改操作。</li>
</ul>
<blockquote>
<p>overlay2 写时复制的操作将会复制整个文件，如果文件过大，将会大大降低文件系统的性能，因此当我们有大量文件需要被修改时，overlay2 可能会出现明显的延迟。好在，写时复制操作只在第一次修改文件时触发，对日常使用没有太大影响。</p>
</blockquote>
<ul>
<li>删除文件或目录：当文件或目录被删除时，overlay2 并不会真正从镜像中删除它，因为镜像层是只读的，overlay2 会创建一个特殊的文件或目录，这种特殊的文件或目录会阻止容器的访问。</li>
</ul>
<h3 id="结语-1">结语</h3>
<p>overlay2 目前已经是 Docker 官方推荐的文件系统了，也是目前安装 Docker 时默认的文件系统，因为 overlay2 在生产环境中不仅有着较高的性能，它的稳定性也极其突出。但是 overlay2 的使用还是有一些限制条件的，例如要求 Docker 版本必须高于 17.06.02，内核版本必须高于 4.0 等。因此，在生产环境中，如果你的环境满足使用 overlay2 的条件，请尽量使用 overlay2 作为 Docker 的联合文件系统。</p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/Docker/Docker-01/">容器的基础概念与操作</a></li>
        
        <li><a href="/post/Docker/Docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">Docker基础知识</a></li>
        
        <li><a href="/post/CircleCI/">使用CircleCI&#43;GitHub 进行CI/CD</a></li>
        
        <li><a href="/post/Golang/Golang-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">Golang 单元测试</a></li>
        
        <li><a href="/post/%E9%85%8D%E7%BD%AE%E5%9B%BE%E5%BA%8A/">linux 下安装配置 Typora &#43; gitee &#43; PicGo-Core 图床</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='https://aszhc.github.io/tags/%E5%AE%B9%E5%99%A8%E5%8C%96'>容器化</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "aszhc/aszhc.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://aszhc.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://aszhc.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://aszhc.github.io/post/Docker/Docker-02/" title="Docker 底层实现原理及关键技术">Docker 底层实现原理及关键技术</a>
    </li>
    
    <li>
        <a href="https://aszhc.github.io/post/CircleCI/" title="使用CircleCI&#43;GitHub 进行CI/CD">使用CircleCI&#43;GitHub 进行CI/CD</a>
    </li>
    
    <li>
        <a href="https://aszhc.github.io/post/Golang/Golang-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" title="Golang 单元测试">Golang 单元测试</a>
    </li>
    
    <li>
        <a href="https://aszhc.github.io/post/%E9%85%8D%E7%BD%AE%E5%9B%BE%E5%BA%8A/" title="linux 下安装配置 Typora &#43; gitee &#43; PicGo-Core 图床">linux 下安装配置 Typora &#43; gitee &#43; PicGo-Core 图床</a>
    </li>
    
    <li>
        <a href="https://aszhc.github.io/post/Docker/Docker-01/" title="容器的基础概念与操作">容器的基础概念与操作</a>
    </li>
    
    <li>
        <a href="https://aszhc.github.io/post/markdown%E4%B8%AD%E7%9A%84emoji%E5%9B%BE%E6%A0%87%E6%A0%87%E7%AD%BE%E8%A1%A8/" title="Markdown中的emoji图标标签表">Markdown中的emoji图标标签表</a>
    </li>
    
    <li>
        <a href="https://aszhc.github.io/post/Golang/Golang-struct-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/" title="Golang Struct 内存对齐">Golang Struct 内存对齐</a>
    </li>
    
    <li>
        <a href="https://aszhc.github.io/post/Golang/Golang-Slice%E5%8E%9F%E7%90%86/" title="Golang Slice原理">Golang Slice原理</a>
    </li>
    
    <li>
        <a href="https://aszhc.github.io/post/Golang/Golang-Map%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="Golang Map的实现原理">Golang Map的实现原理</a>
    </li>
    
    <li>
        <a href="https://aszhc.github.io/post/Golang/Golang%E4%B8%ADmake%E4%B8%8Enew%E6%9C%89%E4%BD%95%E5%8C%BA%E5%88%AB/" title="Golang中make与new有何区别？">Golang中make与new有何区别？</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="https://aszhc.github.io/categories/CI/CD/">CI/CD (1)</a></li>
    
    <li><a href="https://aszhc.github.io/categories/Docker/">Docker (3)</a></li>
    
    <li><a href="https://aszhc.github.io/categories/%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">安装与配置 (1)</a></li>
    
    <li><a href="https://aszhc.github.io/categories/%E5%B7%A5%E5%85%B7/">工具 (1)</a></li>
    
    <li><a href="https://aszhc.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (1)</a></li>
    
    <li><a href="https://aszhc.github.io/categories/%E7%AE%97%E6%B3%95/">算法 (5)</a></li>
    
    <li><a href="https://aszhc.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络 (1)</a></li>
    
    <li><a href="https://aszhc.github.io/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/">语言基础 (5)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="https://aszhc.github.io/tags/Golang/">Golang</a>
    
    <a href="https://aszhc.github.io/tags/markdown/">markdown</a>
    
    <a href="https://aszhc.github.io/tags/markdown/">markdown</a>
    
    <a href="https://aszhc.github.io/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a>
    
    <a href="https://aszhc.github.io/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">单元测试</a>
    
    <a href="https://aszhc.github.io/tags/%E5%93%88%E5%B8%8C/">哈希</a>
    
    <a href="https://aszhc.github.io/tags/%E5%9B%BE%E5%BA%8A/">图床</a>
    
    <a href="https://aszhc.github.io/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/">容器化</a>
    
    <a href="https://aszhc.github.io/tags/%E6%95%B0%E7%BB%84/">数组</a>
    
    <a href="https://aszhc.github.io/tags/%E6%A0%88/">栈</a>
    
    <a href="https://aszhc.github.io/tags/%E7%AC%94%E8%AE%B0/">笔记</a>
    
    <a href="https://aszhc.github.io/tags/%E8%BF%90%E7%BB%B4/">运维</a>
    
    <a href="https://aszhc.github.io/tags/%E9%80%92%E5%BD%92/">递归</a>
    
    <a href="https://aszhc.github.io/tags/%E9%83%A8%E7%BD%B2/">部署</a>
    
    <a href="https://aszhc.github.io/tags/%E9%93%BE%E6%8E%A5/">链接</a>
    
    <a href="https://aszhc.github.io/tags/%E9%93%BE%E8%A1%A8/">链表</a>
    
    <a href="https://aszhc.github.io/tags/%E9%98%9F%E5%88%97/">队列</a>
    
    <a href="https://aszhc.github.io/tags/%E9%9B%86%E5%90%88/">集合</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://blog.csdn.net/Andrew_ZhouC" title="我的CSDN博客">我的CSDN博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://github.com/aszhc" title="我的github">我的github</a>
        </li>
        
    </ul>
</section>

	
	<section class="widget">
        <h3 class="widget-title">公众号</h3>
		<ul class="widget-list">
        <li>
            
                <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJ%0AChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/%0A2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgo%0AKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCABkAGQDASIAAhEBAxEB/8QA%0AHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUF%0ABAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkK%0AFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1%0Adnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXG%0Ax8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEB%0AAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAEC%0AAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRom%0AJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOE%0AhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU%0A1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD6jvLqCytJ%0Arq8mjgtoEaSWWVgqRqBksxPAAHJJrmf+FkeB/wDocfDn/gzh/wDiqX4tf8kr%0A8Y/9ga8/9EPXzJ4h1rwv4C8B+AZJfAOgaxdarpKXE89zGFcsAuSTtOSc0AfT%0A9r8QfBt1cxW9r4s8PzTyuI4449RhZnYnAUANkknjFaE/ibQrddRafWtNiXTS%0Aq3pe6RRaljhRJk/JntnGa+Wmm0DxB4O8A+J9J8K6VoF7J4ytbN/sUYBKLk4L%0AYBwTg49hR8Vvhb8T9V8deLpvDlhM2g6xcI8iJfwxpcqgG3chcHg5xkUAfWwu%0AoDaC6E0ZtinmiXcNmzGd2emMc5rP0LxLoXiAzDQdZ03UzBt837HdJN5ec43b%0AScZwcZ9DXzl4E12bS7o2mg+LNS8aX9vamHUtC1APDBZW67RNIrP8rmMgIFXJ%0AIY4zWu0sOn6XqnjzwJptvovhXSkW6tWsMQpr6j5WSdOHQRuGA3LzuJFAHuVn%0A4s8O32qS6bZa9pVxqMJcSWsV3G8qbfvZQHIx3yOKdoXinQPEEssWha3pepyR%0AKGkWzu45igPQkKTgV87/ALLuu+F9d1TxC17BbQ+MtU1C7vIcQM0kdtIqEqJd%0AuMBi3BIPtzWbo/jbSPgX49PgoaRZS29vJFHe6+ylbiSKQCUlkQEnYJMAc8KK%0AAPrKsCTxn4Xi0qLU5fEejJps0hijumvYhE7jqofdgng8ZrhPFHxD8KeLPhvq%0A2oaN4yvdIsLWeGKbVLS1mEkLFlIULtDHd04HevKr7R/DS/D34X6ZoOpHX9Cn%0A8YRRvNcWzRCUM5DoUYA45I96APoP/hZPgf8A6HHw5/4M4f8A4qtHQ/FvhzXr%0At7XQ9f0nUrlEMrRWl5HM6oCAWIUk4yQM+4r5M+IHj/wn4V8a6zocXwu8MXEd%0AhcNAsrIFLgdyNvFepfD/AErTNJ/aSuI9E021021m8IpcGC2jCIGaeIk4H4fl%0AQB75RRRQBzHxRgmuvhp4st7WKSaeXSbuOOONSzOxhYAADkkntXzVcN4e8Q+E%0AfCmm+L/APxHlvdEsFsw9lp+xCcDcRk5IyOOBX1N4u1g+H/Cms6yIPtB06ymu%0AxCW2+Z5aFtucHGcYzg188+JvG/jrxppmmXGgS3PhbW72DztI0eCZLj+14jhn%0Ak80hVi2ICcNyelAGQ72kuneC/DHhDwX43sbSy8T22pyzarYEKq5KsdwJx1B5%0AGMA810/i3xF4l8UeIvHmi38X2zwXoc8EV5ZabCx1KZX5TySOCQ6gtkj5Qa5a%0A1+J/i7w1CPD3xF1O50XWtOP9ri5d1nbUkH3bIiMERh+f3mTjb0rM8ZN430/Q%0A5Pil4N1C5sdO8SD7ZqcEJjxZ7WEcSlmOZMlm5CjHegDufFF3puo+Jmi+G00M%0AfiiHw1tuZrx1e2SwUkPCwTLC5DFM5GMZya8b+Hfw7TxD4bija4mv9R1lTHp6%0A2EzPFpjqzBmvlA/dq/BXAOcGqfhHWNX+FvjW4uvFOmkz69pjIWedQViuHB8/%0A5Q2fuMdvB+lepeBCnwdTS5/BL/8ACdDxqxiteP7P2G3JHG/dnJkI5242980A%0Ad7oPiLXvDdjYTnQLtvD+iQJol5bxaeTe3N1GoU3EPQNbEY+YkHg8VB8YbbQ/%0AidoXiG2stM1S8udCs3vLHULRA1reymPhI5Fz5pB+UqOhBFN8N+OvF+jadrGm%0A+JNGk1DxleXst9ZaFLeIpTTmAGRMAUwpVxg4Y46VwFv458S6vpHgTSvB2jv4%0AE8O6pqLWtteWt2t0JN0hDjyyAww2484zQB1ng3WPGekeGfD3giRNIh8Tapp8%0ANxpJmtmEFvbxRjcl0CN3m4UjhSM964Twsl5H8Ffh1qNlpmoamumeK/ts8Nhb%0AtNJ5cbFjgD6YGcDJFeieHfFXgXwj4lupPHHj4eIPE+mzSWsV1cadNE9oBlJI%0AhtDKRnPNebeHrLxBoGntbeDviFeL4YuN0WiXEVkEXUdRb/l1CMd0ZLcb2+Wg%0ADS8TWHgTxJ4gv9Y1L4e/FI3l7KZpfLsQq7j6DdxXffDC+uPEHx6u9bh8Pa/p%0AGlx+GhYRtqtmYSXSeI4zyCce+eDV7xXdfFSH4W6JpeiaPc3Pia5tE+3aiL2F%0AJLSVXUkbTw+4BhkHAzWr8NLTVtG8cy6V4j+IV1r2qHS/tL6RNY+UIVLoPN8w%0AEqcHK4/2s0Aes0UUUAZviYTnw7qgs/sX2r7LL5X27/j337Djzf8AYz972zXz%0A9440JT4dTxN8W9RtrNtJjWPTI/Btx5bNDIyq2BIOeSv3SBtzX0Tqun2uraXd%0A6dqEQms7uF4J4ySN6MCrDI5GQT0rwvxp8JdE1Zf+EW1XxHbx6lcfL4Zia3bd%0Ap1rGQzxKA4835Vxuc5HWgDgfBvxL8a/EHVJY7fR/A0aQwkre61ZyKrqrBQnm%0Abjl/mzj2Ndf8Vdf/ALG8M+F7mS3i1PxVZxTeVY6LH5+kFiyBhPGDuxtOU/2g%0AT2rkvBuivqX7NZ06DwtN4nuf7ZuUhjhnMRtpPKZVuOPvbSfung7q0bHwv4i+%0AH/hPwhLol1L4NS+glbxPqckC3CwuhAgMiuSBksyjbj73OcUAcR+0ZdT6v8SP%0ADd5pltHeXUeiWkslvbRmRUcSSEoVXJABIGPeulsvDvi6K6XxzrOh3beIGIn0%0AXSdNjItrKVBscXELkGNWAVgEbJO4nFJ8NvsWifEqx0zwZdp4k1W6mN9qfiK1%0AHlgWbHElu0Jyo+cRvvBB+YDpXrkVi88m8JvB5Py5rzcwzD6ny+7e524TCLEc%0AzcrWOXh+FOk6x4gsb/V7jxjB4gv7IX1xcxXUa2ltK+We3yQXUBicJzwRzRZW%0AlnZ+IJNG8aaTrS69r6rZfaNFtx/ZNqTgLJas3zRsFK72xnduOOlV9a8U3Oie%0ANtPsAmnvotz+5kZ2AeObJ4Bz/u8Y711ut6zr9j4Q1mTwbptze6zMqwwrAVzC%0AzBsSgMCDt44PWjD491ZRi425vMdfBeyi5J7HkNl4JtviH8Qb6w8Q32maf4d8%0AL3M+jmSOdYL66EZYJK5YFZHJA3Nxnniq3ivxDqfxF+GEVo+n2/h3WNAml1iV%0AvIayt5I0RsLAcktMcg446daX4d+FYPiN8T7V9d8GTxQWQnt/Ec73LkXF/tYt%0AIwXb5ZL87V4GawfHWteIvEniQWE+uH4heGtC2atdm3t0tUMS/wCtBKDco2kq%0ATk9c4r0jhPQNJ+K/ivwT8KdHhvre11HWNTtI5dB8mKSfdEjDzftOWDbtpONu%0Aeete4eHL291Pxmt4snhyXTJNKXc0BzfrPuUsrdhEBnjrnFeAeFvHFj4a0WTx%0Af4k0MxNYBT4O0uW6KMtrJ+7mWOQL84CsCS4J44xXsvgH4X6X4d8ey+MdCK2d%0ApqGl+Q2nBWfEjukjSeYzHP3QMYFAHqNFFFAGJ441afQfBevavaJG9xp9hPdx%0ALKCUZo42YBsEHGRzgivAtU8Q+KfjL4RsZPA+n6ZDqsECLqGoSK9tcWkzEMVt%0AZd2QjBWU9cg4717z8QJrK38CeIptWtmu9Oj064e5t0coZYhGxdAw5BIyM+9f%0ALfgv4qeONG8X6JaWmiatL4OuI5G0nRI7VDLLarG3lhJSm9wnyktk5C8mgDZu%0AvG2peGPEVp4c+ItnF4a0/TjHqsbeE4nT7RKDgJNyQ0bLuLDAJIXmuK1r466l%0AF4w8Vf2Na2uvaBq88bw2msxSTJGqDgJHvAXJOSMfwg9q7a68feL/AIpapc2+%0AlaoPB/hK/gOnq2p20UkdzcMdjQLIVzvYMSADn5TitvSvhf4X+FviPwLrOpeI%0ANJ0u+sluTevczsn9oMU2gxh2wu3fzgDqKANXwT8PToeo2M9gttaaRNANae6R%0A1S8a6cc2nAGbXHOzGdwHPFYVt8RNRudGXTrPyYpbmHzPtsLr2+9lc/KBggZ5%0A5HFZHivxZoWp6/H8XL/TpbzStPn/AOEft7SObEn2hC0ouQwO0ptYjac9c1ye%0AheD9M1Cyg1a01HXbfRZNzJqF5om2CJNxB3yiXYMEEE9M1yYnD+1akt0dOHqx%0AinGezOT8SO1z4qhtIpWb7ECXlDlhv5YkHvzxmvqnwF4t0y0k/wBId99xdW9i%0AoRCf3khYLn06HmvAdW8AaJ4e8RWtrqHjxLWe/sxqMVxJYKIJImJ2ncZsHO04%0AHeu40uTR9J+Dl74nk8QJPd3Ba70WW5hFqRdW28JtjLtvYPk4OQeOKn6tJVIS%0AW0b/AImk68JQkur/AEOl+JGgLq3xu8O6FpOo6jodjqNpc3F/Jok32ZpZl3Nu%0AkKjBYkclgTXjPxR8YeJ/CviC10vUfDHhfRbi1ljuZl0i2aOO9jIz5E5DYkiY%0AfeQ9a9CsX8TQa94LsPA2sRaJqPjHSf7c1a5lt0nWe7Me95Nrg7M8/KmFGelc%0A3DF4m+JfgfRvEHj3xTZX2kR6iTBoptkgnv5Y8gwRPGFJeQblUDu1dpxEXwp+%0AJ3hdDrt58StIininmjfT7ddP8+2s48HckKvkRrnbwPSvbPgZ4M1fRJLrV/Ee%0Au6nc3t0siwWEl+ZraO2ZkaNwh5VxjHXABIqj4ih8PeJ/gHqHh2xvrTwzBaxW%0A0NxBfz7jphEyMsc2TkMduOecmuE/ZguvE3iP4pal4h17zb2yi0iTTIdRW3VI%0AX2TQlUBUAE4yfXFAH1PRRRQBynxa/wCSV+Mf+wNef+iHr5ej8A6hpfhzwR4y%0Av/F2vWnh2LTRJc38VwTLpnmKFSOBQd21mZVO0dDzX1b8QHsYvAfiN9Xilm01%0AdNuGuooW2u8QibeFPYlc4r5w1a88KeMNB8PxS/C/4iXem6baCCwltrZyrQnG%0ADuU4boOaAOX+Bdsdcsm0rRry41bU3ndpdPuyRDpsBZV/tGAt8ouVJGMfN8xr%0ArviHdrqXw1+Img6zBFql74MNpb2esXg827k86UF2LtkqSFA4PI60xrjwWfDu%0AieC9X+HvjnStGutXjNvLfRtAouZMoMuxGeCxwPQ+lV/Enw81T4da5faVZaNq%0AeveAfEb5vLLSreS4uo0hGYw0mPlJd89eQpoA4bxJ4v1TWPg3pbweEdE07wxZ%0A6xCry2uFNxdJCch4++5Ty2O2K9h8I+LIvGfgO28M+JNJsfC2keKI3tdDXSk3%0ACQq7ed8g4jw23qBncaq+OPgx4H0HwbFqlh4T8Uald3IVEs7J5JZoWdGYM6Do%0AFIAPuRXP+Etf+JHws8GeErnVdPuJfCamdrqyi01hc2cayEnzmZRs3FsqSelA%0AHYat4f8AG7xw6bJ8MfCet22m2406yv8AUJYXme3jyqMdxypI+bHYk1lTWmpe%0AAfhV8PvC+seEND13W7q/uLVLTUgkscbvK7KVblQSGGTmsT4teKPEOrePtE8Z%0A/DGxutUiOgpbzy2dqbxLZ3aRnhkKBlWRVdcqTkZHrXnnwX8HaLqdpqmpeN9O%0A1GSyNvu0pInaFtQnDENFbk4Er8Y2rk5oA9N+Nfiy/wDh546+Hmtpo9jDfWmi%0ANE+nIcQQMwKNGu3+FckDHHAr0nwn8NbnUtPu7vxFaQaDPPC8VppNhsa20yb+%0AG8twOEn77hgg968q8JeBpPCfjOxg0BH0/wAW63HJqGiPfBimn2hUloLlCMmU%0AJleAcN3rO+E3w48K638P9B1XWtB13Vr7U9Uawkk0532Wy7sCWQD7qDu1AHYa%0Az4H+Idn4jtk03w1p2saJal0uvtt5GBruR8k14hb946n5gWBIIBrS/ZHufEA0%0AfUrOfSbSDw8t1cut1HKN4ud0YMQTP3Quecdq5z4Z6Bo//CY/ED4aS6JrNz4f%0AvtQjjN3BuMVqsIaRRLL/AAlmUAep4ra/ZJ8WWEf9reBoLa4F1azXN+Jjgx+W%0AHjjC9c7uR2oA+j6KKKAOU+LX/JK/GP8A2Brz/wBEPXy58T/GfiPwr8PfhdF4%0Ad1m806OfRFaVYH2hyAmCfzr6z8caTPr3gvX9Is3iS51DT7i1iaUkIryRsoLE%0AAnGTzgGvHtF8GfGHSdC03SYrj4fT2unwLbwG5jnkYIowMkx+1AHA6br+q+JP%0AhP8ADy/12/nv7z/hOraPzpm3NtAbAz+NdPqnxp/4Qfxh8TINXvZL66t7m2XR%0A9NmLhGGD5oVgpCYDA84zjitfUvAHxR8Q3nh6LxBd+C49L0vVrfUzHp4njcmM%0A84zHgnaT6c45rvfiR8JvDPxCnsptdjuY5bXfta0dYy+/bncdpz90Y/GgDg/H%0A+oeIH8Y+HdbvfEt/4Y8G3lhagSW375Jb53LeQY1+f5k/jI2/L1rvtc8deBtQ%0A8Rz+A9YvY7jVLllt5NPktZWVyyhwpbZs5BB61kfG/wCHGo+NPh3pnhzw3c2l%0AvLY3UMqSXsjKPLjjdOqqx3fMO3rXnni74EeK9X8B+CtLs9R0ePWtH+1G8u3n%0AlHmmSQMm1xGWbAGOQMdqAOS8OeE/F2kfFzVvBcOtX3hLRr5rvVbZLN0lVoN7%0AKjbVbjKoBg4IC9K0/Ctl4Vtvh/4mPhnxrc+JJfD+nS32nRTWEluNNm+ZhNEX%0AA+Yt6V73c6H4jsPA2i2nh59GPiSztre1lub4O8bKigSYYLuOcHGQOvNZ978H%0AvDF145/4So/bYb8yRSNBDKEt38tVABj28g7RkZ55oA8+8K6JFquj+HYdY8b3%0A58e69p8Wo6Zftas89nCYw8saOPl2kbgckE56Vwf/AAgPxW8CfCtb/TNW1Kwk%0AtZJ57zS4rmER20CqztMGDkMTj7oyeelem/H74ReI/HuvaLfeFr7TLCOwtWty%0AJ5pImGWz8uxG4xx2p2ofCfxTBrHhzTdD1SwbwXpWpwai8d9cSteS4YGVGITa%0AykZAUkD1oA8b0PxPrfgv4U+KdS1jU7mx8S+Kmtb3SLkPvkulSQea+5chPlY8%0APtJzxmvpHwDZeBtH8Tpp+i2Vna+LZdKW8ufKt3V3gdk3MXxtOX28Zz7Vx3jn%0A4e/EfWPiDYa7pVx4OWy0gzJplvdLNxFIu0iRRGQTj0PWtr4d+CfG1n8Urvxd%0A43u/D8xl0k6aiaWZRj96jqdroBjCt39OKAPXqKKKACiiigAooooAKKKKACii%0AigAooooAKKKKACiiigD/2Q==">
           
        </li>
    </ul>
    </section>
	
    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://aszhc.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2021 <a href="https://aszhc.github.io">PHOENIX By 周闖</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank"></a>         	</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

</body>

</html>